<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Employee Reviews</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<style>
:root{
  --emerald-50:#f0f8f3;
  --emerald-100:#e3f4ea;
  --emerald-600:#0A5C30;
  --emerald-700:#084725;
  --emerald-800:#06371f;
  --gold-400:#C9A14A;
  --gray-100:#f6f8fa;
  --gray-200:#e5e7eb;
  --gray-400:#94a3b8;
  --gray-600:#475569;
  --surface:#ffffff;
  --shadow:0 18px 36px rgba(10,92,48,0.12);
  --status-available:#16a34a;
  --status-booked:#dc2626;
  --status-mine:#2563eb;
}
*,*::before,*::after{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Inter',Roboto,Arial,sans-serif;
  line-height:1.6;
  background:linear-gradient(135deg,#f6f8fa 0%,#eaf4ff 100%);
  color:#1f2933;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
h1,h2,h3,h4{
  font-family:'Inter',Arial,sans-serif;
  color:var(--emerald-700);
  margin:0;
}
h1{font-size:clamp(1.75rem,4vw,2.5rem);}
h2{font-size:clamp(1.25rem,3vw,1.75rem);}
main{flex:1;width:100%;}
.app-header{
  background:var(--emerald-600);
  color:#fff;
  position:sticky;
  top:0;
  z-index:70;
  box-shadow:0 16px 40px rgba(8,71,37,0.32);
}
.nav-bar{
  position:relative;
  width:min(1100px,100%);
  margin:0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1rem;
  padding:0.75rem clamp(1.25rem,4vw,2.75rem);
}
.nav-brand{
  display:flex;
  align-items:center;
  gap:0.9rem;
}
.nav-brand img{
  width:3.5rem;
  height:3.5rem;
  object-fit:contain;
  filter:drop-shadow(0 10px 18px rgba(0,0,0,0.25));
}
.brand-text{display:flex;flex-direction:column;gap:0.15rem;}
.brand-title{font-size:1.05rem;font-weight:600;line-height:1.2;letter-spacing:0.01em;}
.brand-sub{font-size:0.8rem;opacity:0.75;}
.nav-toggle{
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.25);
  border-radius:0.9rem;
  color:#fff;
  width:44px;
  height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:background .2s ease,transform .2s ease;
}
.nav-toggle:hover{background:rgba(255,255,255,0.22);}
.nav-toggle:active{transform:scale(0.96);}
.nav-items{
  position:absolute;
  left:0;
  right:0;
  top:100%;
  display:flex;
  flex-direction:column;
  gap:0.75rem;
  background:var(--emerald-700);
  padding:1rem clamp(1.25rem,5vw,2.5rem);
  transform:scaleY(0);
  transform-origin:top;
  transition:transform .25s ease,opacity .25s ease;
  opacity:0;
  pointer-events:none;
  border-bottom-left-radius:1.25rem;
  border-bottom-right-radius:1.25rem;
  box-shadow:0 22px 36px rgba(8,71,37,0.4);
}
.nav-items.show{
  transform:scaleY(1);
  opacity:1;
  pointer-events:auto;
}
.nav-items button{
  background:none;
  border:none;
  color:#fff;
  font-size:1rem;
  font-weight:500;
  padding:0.5rem 0;
  text-align:left;
  display:flex;
  align-items:center;
  gap:0.4rem;
  cursor:pointer;
  transition:opacity .2s ease;
}
.nav-items button:hover{opacity:0.8;}
.lang-switch{display:flex;align-items:center;gap:0.35rem;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;}
.switch{position:relative;display:inline-block;width:42px;height:24px;}
.switch input{opacity:0;width:0;height:0;}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;transition:.4s;border-radius:9999px;}
.slider:before{position:absolute;content:"";height:20px;width:20px;left:2px;bottom:2px;background:white;transition:.4s;border-radius:50%;box-shadow:0 4px 10px rgba(15,23,42,0.25);}
.switch input:checked + .slider{background:#059669;}
.switch input:checked + .slider:before{transform:translateX(18px);}
.hidden{display:none !important;}
section[data-view]{
  width:min(1100px,100%);
  margin:0 auto;
  padding:clamp(1.75rem,4vw,3rem) clamp(1.25rem,4vw,2.75rem);
  display:flex;
  flex-direction:column;
  gap:1.5rem;
}
.home-hero{
  display:flex;
  flex-direction:column;
  gap:0.75rem;
}
.home-actions{
  display:grid;
  gap:1rem;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
}
.home-card{
  background:var(--surface);
  padding:1.5rem;
  border-radius:1.25rem;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:0.9rem;
}
.home-card p{margin:0;color:var(--gray-600);}
.home-card button{
  align-self:flex-start;
  border:none;
  border-radius:9999px;
  padding:0.65rem 1.25rem;
  font-weight:600;
  font-size:0.95rem;
  cursor:pointer;
  background:var(--emerald-600);
  color:#fff;
  transition:transform .2s ease,box-shadow .2s ease;
}
.home-card button:hover{transform:translateY(-1px);box-shadow:0 12px 18px rgba(10,92,48,0.18);}
.home-card.secondary button{background:transparent;color:var(--emerald-700);border:1px solid rgba(10,92,48,0.25);}
.home-card.secondary button:hover{background:var(--emerald-50);box-shadow:none;}
.card{
  background:var(--surface);
  border-radius:1.25rem;
  box-shadow:var(--shadow);
  padding:clamp(1.25rem,3vw,1.75rem);
  display:flex;
  flex-direction:column;
  gap:1rem;
}
.review-summary{
  gap:0.75rem;
}
.review-summary-head{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:0.75rem;
}
.review-summary-title{
  font-size:1.1rem;
  font-weight:600;
  color:var(--emerald-700);
}
.review-status-badge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:0.25rem 0.75rem;
  border-radius:9999px;
  font-size:0.8rem;
  font-weight:600;
  text-transform:capitalize;
  background:var(--gray-200);
  color:var(--gray-600);
}
.review-status-badge.status-draft{
  background:#f1f5f9;
  color:#475569;
}
.review-status-badge.status-submitted{
  background:#fef3c7;
  color:#b45309;
}
.review-status-badge.status-final{
  background:#dcfce7;
  color:#166534;
}
.review-summary-meta{
  display:flex;
  flex-wrap:wrap;
  gap:1.25rem;
  font-size:0.9rem;
  color:var(--gray-600);
}
.review-meta-item{
  display:flex;
  flex-direction:column;
  gap:0.2rem;
  min-width:150px;
}
.review-meta-label{
  font-size:0.75rem;
  letter-spacing:0.08em;
  text-transform:uppercase;
  color:var(--gray-400);
}
.review-meta-value{
  font-weight:600;
  color:var(--emerald-700);
}
.reviews-empty{
  margin:0;
  color:var(--gray-600);
  font-style:italic;
}
#reviewForm{
  display:flex;
  flex-direction:column;
  gap:1.5rem;
}
.review-sidebar{
  display:flex;
  flex-direction:column;
  gap:0.85rem;
}
.review-sidebar .sidebar-head{
  display:flex;
  flex-direction:column;
  gap:0.35rem;
}
.review-sidebar .sidebar-head h2{
  font-size:1.05rem;
}
.review-sidebar .sidebar-head p{
  margin:0;
  color:var(--gray-600);
  font-size:0.9rem;
}
.form-actions{
  display:flex;
  flex-direction:column;
  gap:0.75rem;
}
.form-actions #submitMsg{
  font-weight:600;
  color:var(--emerald-700);
}
.form-actions .primary{
  min-width:200px;
}
.form-actions .primary.secondary{
  background:transparent;
  color:var(--emerald-700);
  border:1px solid rgba(10,92,48,0.3);
}
.form-actions .primary.secondary:hover{
  background:var(--emerald-50);
}
@media (max-width:639px){
  .form-actions .primary{
    width:100%;
  }
}
.form-footnote{
  text-align:center;
  color:var(--gray-600);
}
.form-footnote small{color:inherit;}
@media (min-width:640px){
  .form-actions{
    flex-direction:row;
    align-items:center;
    gap:1rem;
    justify-content:flex-start;
  }
  .form-actions #submitMsg{
    margin-left:auto;
  }
}
@media (min-width:1024px){
  #reviewForm{
    display:grid;
    grid-template-columns:minmax(260px,320px) minmax(0,1fr);
    gap:1.75rem;
    align-items:start;
  }
  #reviewForm>[data-i18n-key="intro"]{
    grid-column:1/-1;
  }
  #reviewSidebar{
    grid-column:1;
    position:sticky;
    top:1.5rem;
    align-self:start;
  }
  #reviewsList{
    max-height:calc(100vh - 220px);
    overflow:auto;
    padding-right:0.25rem;
  }
  #questionList,
  #finalBlock,
  #signaturesCard{
    grid-column:2;
  }
  #questionList,
  #finalBlock,
  #signaturesCard{
    max-width:720px;
    width:100%;
    justify-self:start;
  }
  #compAdjust{
    grid-column:1;
    align-self:start;
  }
  #reviewForm .form-actions,
  #reviewForm .form-footnote{
    grid-column:1/-1;
  }
  #questionList{
    gap:1.5rem;
  }
}
.question-title{font-size:1.15rem;font-weight:600;color:var(--emerald-700);}
.card-title{font-weight:600;font-size:1rem;color:var(--emerald-700);}
label{
  display:flex;
  flex-direction:column;
  gap:0.35rem;
  font-size:0.95rem;
  color:#1f2937;
  font-weight:500;
}
input,textarea,select{
  font:inherit;
  border-radius:0.85rem;
  border:1px solid var(--gray-200);
  background:#fff;
  padding:0.65rem 0.9rem;
  transition:border .2s ease,box-shadow .2s ease;
  width:100%;
}
input:focus,textarea:focus,select:focus{
  outline:none;
  border-color:rgba(10,92,48,0.45);
  box-shadow:0 0 0 3px rgba(10,92,48,0.18);
}
textarea{min-height:140px;resize:vertical;}
input[type=radio],input[type=checkbox]{width:auto;padding:0;border-radius:999px;}
.signature{font-family:'Dancing Script',cursive;font-size:1.35rem;}
.sign-date{width:auto;max-width:240px;align-self:flex-start;}
.rating-group{
  display:flex;
  flex-direction:column;
  gap:0.65rem;
  padding-top:0.5rem;
}
.rating-group label{
  display:flex;
  align-items:center;
  gap:0.6rem;
  flex-wrap:wrap;
  border:1px solid rgba(10,92,48,0.2);
  border-radius:0.85rem;
  padding:0.6rem 0.9rem;
  font-weight:500;
}
.rating-group input{accent-color:var(--emerald-600);}
#questionList{display:flex;flex-direction:column;gap:1.25rem;}
#reviewsList{display:grid;gap:1rem;}
.callout{
  background:rgba(201,161,74,0.12);
  border-left:4px solid var(--gold-400);
  border-radius:0.75rem;
  padding:1rem 1.25rem;
  color:#4b5563;
}
.rating-badges{display:flex;flex-wrap:wrap;gap:0.5rem;}
.badge{display:inline-flex;align-items:center;justify-content:center;padding:0.35rem 0.85rem;border-radius:999px;font-size:0.85rem;font-weight:600;color:#fff;}
.badge-gray{background:#6b7280;}
.flex{display:flex;}
.items-start{align-items:flex-start;}
.items-center{align-items:center;}
.justify-between{justify-content:space-between;}
.justify-center{justify-content:center;}
.gap-4{gap:1rem;}
.space-y-1> * + *{margin-top:0.25rem;}
.mb-4{margin-bottom:1rem;}
.mb-1{margin-bottom:0.25rem;}
.mt-2{margin-top:0.5rem;}
.pl-4{padding-left:1rem;}
.fixed{position:fixed;}
.inset-0{top:0;right:0;bottom:0;left:0;}
.p-4{padding:1rem;}
.pt-16{padding-top:4rem;}
.p-6{padding:1.5rem;}
.p-8{padding:2rem;}
.space-y-4> * + *{margin-top:1rem;}
.w-full{width:100%;}
.w-80{width:20rem;max-width:100%;}
.max-w-3xl{max-width:48rem;}
.w-12{width:3rem;}
.h-12{height:3rem;}
.bottom-6{bottom:1.5rem;}
.right-6{right:1.5rem;}
.overflow-auto{overflow:auto;}
.overflow-x-auto{overflow-x:auto;}
.bg-white{background:#fff;}
.bg-white\/90{background:rgba(255,255,255,0.9);}
.bg-black\/30{background:rgba(0,0,0,0.3);}
.bg-emerald-600{background:var(--emerald-600);}
.text-white{color:#fff;}
.text-red-600{color:#dc2626;}
.text-center{text-align:center;}
.text-lg{font-size:1.125rem;}
.text-xl{font-size:1.25rem;}
.font-bold{font-weight:700;}
.font-semibold{font-weight:600;}
.rounded-xl{border-radius:0.75rem;}
.rounded-full{border-radius:9999px;}
.shadow-lg{box-shadow:0 20px 35px rgba(15,23,42,0.18);}
.shadow-xl{box-shadow:0 25px 50px rgba(15,23,42,0.2);}
.px-1{padding-left:0.25rem;padding-right:0.25rem;}
.px-2{padding-left:0.5rem;padding-right:0.5rem;}
.py-1{padding-top:0.25rem;padding-bottom:0.25rem;}
.border{border:1px solid var(--gray-200);border-radius:0.75rem;}
.list-disc{list-style:disc;padding-left:1.25rem;}
.badge-green{background:var(--emerald-600);}
.badge-gold{background:var(--gold-400);color:#1f2937;}
#review-intro{
  background:linear-gradient(135deg,rgba(255,255,255,0.95),rgba(235,250,243,0.95));
  border-radius:1.5rem;
  padding:clamp(1.5rem,4vw,2.25rem);
  display:flex;
  flex-direction:column;
  gap:1.5rem;
}
#review-intro h1{text-align:center;color:var(--emerald-700);font-weight:700;}
#review-intro .intro-cards{display:flex;flex-direction:column;gap:1.25rem;}
#review-intro .info-card{background:#fff;border-radius:1rem;box-shadow:0 12px 30px rgba(6,55,31,0.08);padding:clamp(1.25rem,3vw,1.75rem);display:flex;flex-direction:column;gap:1.25rem;}
#review-intro .info-card--combined{gap:clamp(1.25rem,2.5vw,1.75rem);}
#review-intro .info-card__header{display:flex;flex-direction:column;gap:0.65rem;}
#review-intro .info-card__header p{margin:0;color:var(--gray-600);font-size:1rem;max-width:62ch;line-height:1.7;}
#review-intro .info-card__grid{display:grid;grid-template-columns:1fr;gap:clamp(1.25rem,2.5vw,1.75rem);}
#review-intro .info-section{display:flex;flex-direction:column;gap:0.75rem;}
#review-intro .info-section h3{font-size:1.05rem;color:var(--emerald-700);margin:0;font-weight:600;letter-spacing:0.01em;}
#review-intro .info-section--wide{grid-column:1/-1;}
#review-intro .info-section p{margin:0;color:var(--gray-600);line-height:1.7;max-width:65ch;}
#review-intro .info-section p + p{margin-top:0.35rem;}
#review-intro .info-section .info-footnote{font-size:0.95rem;}
#review-intro .info-section .info-footnote--highlight{background:linear-gradient(90deg,rgba(201,161,74,0.12),rgba(201,161,74,0));border-radius:0.75rem;padding:0.65rem 0.85rem;color:var(--emerald-700);}
#review-intro .info-section .info-subtitle{font-size:1rem;color:var(--emerald-600);text-transform:uppercase;letter-spacing:0.08em;margin-top:0.75rem;}
.values-list{list-style:none;padding:0;margin:0;display:flex;flex-wrap:wrap;gap:0.5rem;}
.values-list li{background:var(--emerald-600);color:#fff;padding:0.35rem 0.9rem;border-radius:999px;font-size:0.85rem;letter-spacing:0.02em;}
#review-intro .rating-badges{display:flex;flex-wrap:wrap;gap:0.5rem;}
#review-intro .rating-badges .badge{padding:0.4rem 0.85rem;font-size:0.85rem;letter-spacing:0.02em;}
#review-intro .info-meta{display:grid;gap:0.65rem;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));margin:0;}
#review-intro .info-meta__item{background:var(--emerald-50);border-radius:0.9rem;padding:0.75rem 1rem;display:flex;flex-direction:column;gap:0.25rem;box-shadow:inset 0 0 0 1px rgba(10,92,48,0.08);}
#review-intro .info-meta__item dt{font-size:0.75rem;text-transform:uppercase;letter-spacing:0.14em;color:var(--emerald-700);font-weight:600;}
#review-intro .info-meta__item dd{margin:0;font-weight:500;color:var(--emerald-800);line-height:1.5;}
#review-intro .process-steps{counter-reset:step;list-style:none;padding:0;margin:0;display:grid;gap:0.75rem;}
#review-intro .process-steps li{counter-increment:step;display:flex;align-items:flex-start;gap:0.75rem;background:#fff;border-radius:0.9rem;padding:0.75rem 1rem;box-shadow:0 10px 20px rgba(6,55,31,0.08);border:1px solid rgba(10,92,48,0.08);}
#review-intro .process-steps li::before{content:counter(step);flex:none;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:var(--emerald-600);color:#fff;font-weight:600;box-shadow:0 6px 12px rgba(10,92,48,0.2);margin-top:0.1rem;}
#review-intro .process-steps span{display:block;font-weight:500;color:var(--emerald-800);line-height:1.5;}
#review-intro .info-callout{background:linear-gradient(120deg,rgba(10,92,48,0.08),rgba(10,92,48,0));border-radius:1rem;padding:0.85rem 1rem;color:var(--emerald-800);font-size:0.95rem;font-weight:500;}
@media (min-width:768px){
  #review-intro .info-card__header{flex-direction:row;align-items:center;justify-content:space-between;gap:1.5rem;}
  #review-intro .info-card__header h2{margin:0;}
  #review-intro .info-card__header p{max-width:55ch;}
}
@media (min-width:900px){
  #review-intro .info-card__grid{grid-template-columns:repeat(2,minmax(0,1fr));}
}
button.primary{
  background:var(--emerald-600);
  color:#fff;
  border:none;
  border-radius:9999px;
  padding:0.75rem 1.5rem;
  font-size:1rem;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 12px 22px rgba(10,92,48,0.18);
  transition:transform .2s ease,box-shadow .2s ease;
}
button.primary:hover{transform:translateY(-1px);box-shadow:0 18px 28px rgba(10,92,48,0.22);}
button.primary:active{transform:translateY(0);box-shadow:0 8px 18px rgba(10,92,48,0.2);}
button.secondary{
  background:transparent;
  color:var(--emerald-700);
  border:1px solid rgba(10,92,48,0.3);
  box-shadow:none;
}
button.secondary:hover{background:var(--emerald-50);box-shadow:none;}
#submitMsg{font-weight:600;color:var(--emerald-700);}
.loading-bar{height:4px;background:rgba(15,118,110,0.12);position:sticky;top:0;z-index:60;overflow:hidden;}
.loading-bar span{display:block;height:100%;background:var(--emerald-600);width:100%;animation:loadAnim 1.2s linear infinite;}
@keyframes loadAnim{from{transform:translateX(-100%);}to{transform:translateX(100%);}}
#snackbar{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:0.75rem 1.5rem;border-radius:999px;opacity:0;transition:opacity .3s ease,transform .3s ease;z-index:80;}
#snackbar.show{opacity:1;transform:translate(-50%,0);}
.schedule-layout{display:flex;flex-direction:column;gap:1.5rem;}
.schedule-hero{display:flex;flex-direction:column;gap:0.6rem;}
.schedule-hero h2{margin:0;color:var(--emerald-700);}
.schedule-hero p{margin:0;color:var(--gray-600);}
.schedule-columns{display:grid;gap:1.5rem;}
.schedule-sidebar{display:flex;flex-direction:column;gap:1.25rem;}
.calendar-card{display:flex;flex-direction:column;gap:1rem;}
.calendar-head{display:flex;flex-direction:column;gap:0.35rem;}
.calendar-head p{margin:0;color:var(--gray-600);}
.booking-calendar{min-height:520px;}
.booking-legend{display:flex;flex-wrap:wrap;gap:0.75rem;}
.booking-legend span{display:inline-flex;align-items:center;gap:0.4rem;font-size:0.85rem;color:var(--gray-600);}
.booking-dot{width:10px;height:10px;border-radius:999px;display:inline-block;}
.booking-dot.available{background:var(--status-available);}
.booking-dot.booked{background:var(--status-booked);}
.booking-dot.mine{background:var(--status-mine);}
.booking-list{display:flex;flex-direction:column;gap:1rem;}
.booking-item{background:#fff;border:1px solid var(--gray-200);border-radius:1rem;padding:0.85rem 1rem;box-shadow:0 12px 24px rgba(15,23,42,0.08);}
.booking-item h4{margin:0 0 0.3rem;font-size:1rem;color:var(--emerald-700);}
.booking-item time{display:block;font-weight:600;color:var(--emerald-700);}
.booking-item span{display:block;font-size:0.9rem;color:var(--gray-600);}
.booking-empty{font-size:0.95rem;color:var(--gray-500);}
.booking-help{margin-top:0.5rem;font-size:0.85rem;color:var(--gray-500);}
.manager-tools{display:flex;flex-direction:column;gap:1rem;}
.availability-form{display:flex;flex-direction:column;gap:0.75rem;}
.availability-form label{display:flex;flex-direction:column;gap:0.35rem;font-weight:600;color:var(--emerald-700);}
.availability-form input{padding:0.55rem 0.75rem;border-radius:0.65rem;border:1px solid var(--gray-200);font-size:0.95rem;}
.manager-slots{display:flex;flex-direction:column;gap:0.75rem;}
#bookingSummary h3{margin-top:0;margin-bottom:0.35rem;color:var(--emerald-700);}
#guideCard{overflow:hidden;}
#slotList{display:flex;flex-direction:column;gap:0.75rem;max-height:320px;overflow-y:auto;padding-right:0.35rem;}
#availMsg{font-size:0.85rem;color:var(--emerald-700);}
.slot-row{display:flex;flex-wrap:wrap;align-items:center;gap:0.5rem 0.75rem;justify-content:flex-start;padding:0.85rem 1rem;border:1px solid var(--gray-200);border-radius:1rem;background:#fff;box-shadow:0 10px 22px rgba(15,23,42,0.08);}
.slot-row-booked{background:var(--emerald-100);border-color:rgba(10,92,48,0.25);}
.slot-range{flex:1 1 160px;font-weight:600;color:var(--emerald-700);}
.slot-status{flex:1 1 100%;font-size:0.85rem;color:var(--gray-500);}
.slot-assign{flex:1 1 160px;max-width:240px;}
.slot-save{padding:0.5rem 1.1rem;font-size:0.85rem;box-shadow:none;margin-left:auto;}
.slot-save:hover{box-shadow:0 10px 20px rgba(10,92,48,0.16);}
#calendar{width:100%;}
.fc .booking-event{border:none !important;box-shadow:none !important;font-weight:600;}
.fc .booking-open{background:#dcfce7 !important;color:#166534 !important;}
.fc .booking-booked{background:#fee2e2 !important;color:#b91c1c !important;}
.fc .booking-mine{background:#dbeafe !important;color:#1d4ed8 !important;}
.fc .booking-past{opacity:0.5;}
#devPanel{z-index:70;}
#devPanel table{width:100%;border-collapse:collapse;font-size:0.95rem;}
#devPanel th,#devPanel td{padding:0.75rem;border-bottom:1px solid var(--gray-200);text-align:left;}
#devPanel th{background:var(--emerald-100);color:var(--emerald-800);}
#devPanel .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.45);z-index:80;}
#devPanel .modal.hidden{display:none;}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.4);z-index:80;}
.modal.hidden{display:none;}
#errorModal .card,#devPanel .modal .card{box-shadow:0 18px 32px rgba(15,23,42,0.25);}
#addUserFab{z-index:90;}
#accessDenied{z-index:90;}
#login{
  background:linear-gradient(135deg,#f6f8fa 0%,#eaf4ff 100%);
  min-height:calc(100vh - 64px);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:clamp(2rem,6vw,4rem);
}
#login .card-like{
  background:rgba(255,255,255,0.9);
  border-radius:1.5rem;
  box-shadow:0 32px 60px rgba(15,23,42,0.18);
  padding:clamp(1.75rem,4vw,2.75rem);
  display:flex;
  flex-direction:column;
  gap:1.25rem;
  width:min(420px,100%);
}
#login img{height:100px;object-fit:contain;}
#login button.primary{width:100%;}
#submitMsg{min-width:120px;}
@media(min-width:768px){
  .nav-toggle{display:none;}
  .nav-items{
    position:static;
    transform:none;
    opacity:1;
    pointer-events:auto;
    flex-direction:row;
    align-items:center;
    gap:1.25rem;
    background:transparent;
    padding:0;
    box-shadow:none;
    border-radius:0;
  }
  .nav-items button{
    padding:0.55rem 1rem;
    border-radius:9999px;
    background:rgba(255,255,255,0.12);
  }
  .nav-items button:hover{opacity:1;background:rgba(255,255,255,0.22);}
  .schedule-columns{grid-template-columns:minmax(0,300px) minmax(0,1fr);align-items:start;}
}
@media(min-width:1024px){
  .schedule-columns{grid-template-columns:minmax(0,360px) minmax(0,1fr);}
  .booking-calendar{min-height:640px;}
}
@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important;scroll-behavior:auto !important;}
}
</style>
<script>
let user=null,config={},lang=localStorage.getItem('lang')||'en';
let loadingReviews=false;
let pendingSection=null;
let currentReviewId=null;
let selectedYear=new Date().getFullYear();
let resetUid=null;

const defaultQuestions=[
  {id:'attendance',en:'Attendance & Punctuality',es:'Asistencia y Puntualidad',extras:[
    {id:'absences',label:'Absences without notice (days)',label_es:'Ausencias sin aviso (días)',type:'number'},
    {id:'late',label:'Late arrivals (days)',label_es:'Llegadas tarde (días)',type:'number'},
    {id:'employeeComments',label:"Employee's Comments",label_es:'Comentarios del empleado',type:'textarea'}]},
  {id:'performance',en:'Performance Improvements: What did you do more, better, or more efficiently last year, up till now?',es:'Mejoras de rendimiento',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'values',en:'Living Our Core Values: How have you embodied our core values? Provide specific examples.',es:'Vivir nuestros valores',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'growth',en:'Personal Growth: How did you improve your knowledge or skills last year, up till now?',es:'Crecimiento personal',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'learning',en:'Learning New Skills: Did you take or create opportunities to learn a new skill or enhance an existing one?',es:'Aprendizaje de nuevas habilidades',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'team',en:'Team Support: How did you support your teammates in developing their skills?',es:'Apoyo al equipo',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'flexibility',en:'Flexibility: When asked to cover for others, did you agree? Share an example.',es:'Flexibilidad',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'initiative',en:'Initiative: Describe a time you proactively improved a process or solved a problem without being asked.',es:'Iniciativa',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'proactive',en:'Proactive Contributions: How did you proactively use downtime to tackle additional tasks?',es:'Contribuciones proactivas',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'innovation',en:'Innovation & Process Improvement: Have you suggested or implemented improvements to our processes, services, or workplace? Describe your idea and its impact.',es:'Innovaci\u00f3n y mejora de procesos',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'crossshadow',en:'Cross Shadowing Program Participation',es:'Programa Cross Shadowing',rating:false,extras:[
    {id:'participation',label:'Did you participate? (Yes/No/Partial)',label_es:'¿Participaste? (Sí/No/Parcial)',type:'select',options:['Yes','No','Partial']},
    {id:'employeeComments',label:"Employee's Comments",label_es:'Comentarios del empleado',type:'textarea'}]},
  {id:'future',en:'Future Interests: Is there another role or skill you\u2019d like to explore in the future?',es:'Intereses futuros',rating:false,extras:[{id:'employeeComments',type:'textarea'}]}
];
const translations={
  en:{
    home:'Home',reviews:'Reviews',schedule:'Schedule',navTitle:'Employee Annual Reviews',navSubtitle:'Empower your review journey',
    welcomeTitle:'Welcome to the Employee Review Portal',
    welcomeMsg:'Select an option from the navigation bar to view your reviews or schedule a meeting. Use the language button to switch between English and Spanish.',
    homeReviewsCardTitle:'Complete your self-review',
    homeReviewsCardBody:'Stay prepared by answering each question with clear examples and track your progress in one place.',
    homeScheduleCardTitle:'Reserve your review time',
    homeScheduleCardBody:'Browse available slots, see what\'s already booked, and lock in a time that works for you and your manager.',
    homeGuideCardTitle:'Need a hand?',
    homeGuideButton:'Open portal',
    comingSoon:'Coming soon...',userId:'User ID',password:'Password',login:'Login',logout:'Logout',
    loginFail:'Login failed',invalidPwd:'Invalid password.',
    noAccount:'Account not found. Please reach out to Sea Khun to be added.',
    curWage:'Current Wage',newWage:'New Wage',pctIncrease:'% Increase:',
    finalExpTitle:'Final Performance Expectation',belowExp:'Below Expectations',meetsExp:'Meets Expectations',exceedsExp:'Exceeds Expectations',
    below:'Below',meets:'Meets',exceeds:'Exceeds',
    notesPlaceholder:'Notes',contactQuestions:'Please contact Sea Khun HR/IT Manager with any questions or concerns.',empSignature:'Employee Signature',mgrSignature:'Manager Signature',signDate:'Date',submitReview:'Submit Review',
    employeeComments:"Employee's Comments",managerComments:"Manager's Comments",
    reviewSaved:'Review saved',saveFailed:'Failed to save review',saving:'Saving...',
    reviewSidebarTitle:'Your reviews',
    reviewSidebarSubtitle:'Track progress and revisit submitted forms.',
    reviewListEmpty:'No reviews available yet.',
    reviewTypeSELF:'Self review',
    reviewTypeMANAGER:'Manager review',
    reviewTypeHR:'HR review',
    reviewStatusDRAFT:'Draft',
    reviewStatusSUBMITTED:'Submitted',
    reviewStatusFINAL:'Finalized',
    reviewYearLabel:'Review year',
    reviewLastUpdated:'Last updated',
    reviewFinalExpectation:'Final expectation',
    reviewFinalNotSet:'Not set',
    reviewAssignedTo:'Employee',
    reviewOwnedByYou:'You',
    scheduleBtn:'Schedule Review Meeting',
    scheduleHeroTitle:'Book your review',
    scheduleHeroSubtitle:'Choose a 30-minute slot that works for both you and your manager.',
    scheduleCalendarTitle:'Pick a time that works',
    scheduleCalendarSubtitle:'Tap any green slot to instantly reserve it. Red slots are already taken and blue slots are the ones you\'ve booked.',
    scheduleLegendAvailable:'Open slot',
    scheduleLegendMine:'Booked by you',
    scheduleLegendBooked:'Booked',
    scheduleNoBooking:'You haven\'t reserved a review yet. Choose an available time on the calendar to lock it in.',
    scheduleNextBookingTitle:'Your review is booked',
    scheduleUpcomingLabel:'Upcoming review',
    scheduleBookingHelp:'Need to make a change? Contact your manager or HR for help.',
    scheduleManagerToolsTitle:'Manager availability tools',
    scheduleManagerSlotsTitle:'Posted availability',
    scheduleManagerNoSlots:'You haven\'t shared any availability yet. Use the form above to add 30-minute blocks.',
    scheduleBookConfirm:'Book this review on {date} at {time} with {manager}?',
    scheduleBookSuccess:'Review booked!',
    scheduleBookConflict:'Someone just booked that slot. Please choose another time.',
    scheduleBookedLabel:'Booked',
    scheduleAvailableLabel:'Available',
    scheduleBookedBy:'Booked by',
    scheduleManagerLabel:'Manager',
    scheduleViewOnly:'This slot is already reserved.',
    scheduleAssignPrompt:'Enter the employee ID to assign this slot:',
    scheduleAssignError:'Employee ID is required.',
    cancel:'Cancel',
    conflict:'Slot already booked',
    selDate:'Select Date',
    selTime:'Select Time',
    fromDate:'Start Date',
    fromTime:'Start Time',
    toDate:'End Date',
    toTime:'End Time',
    book:'Book',
    chooseTime:'Please choose date and time',
    bookOk:'Meeting booked',
    error:'Error occurred',
    scheduleGuide:`<div class="callout"><h3 class="font-bold mb-1">Booking & Availability Guidelines</h3><ul class="list-disc pl-4 space-y-1"><li><strong>Production Team</strong> – Reserve reviews <strong>12:00 PM – 2:00 PM</strong> (post-production). These slots have priority for the conference room.</li><li><strong>Delivery Drivers</strong> – Aim for <strong>Wednesdays</strong> (non-Route day).</li><li><strong>CSRs</strong> – Book any other open time that works for you and your manager.</li><li><strong>One Room. One Slot. One Team.</strong> – Only <strong>one 30-minute</strong> booking at a time; no double-booking allowed.</li></ul></div>`,
    compAdjustTitle:'Compensation Adjustment',
    saveSlotBtn:'Save',
    addSlotTitle:'Set Availability',
    addSlotBtn:'Add Slot',
    slotListTitle:'Slots',
    slotsSaved:'slot(s) saved',
    availableShort:'Available',
    bookedShort:'Booked',
    errorPast:'Cannot add slots in the past.',
    errorOverlap:'Slot overlaps with existing.',
    errorMissing:'Please fill all fields.',
    errorInvalid:'Invalid time range.',
    intro:`<section id="review-intro">
      <h1>Your Opportunity to Shine</h1>
      <div class="intro-cards">
        <div class="info-card info-card--combined">
          <div class="info-card__header">
            <h2>Purpose</h2>
            <p>Highlight achievements, live our core values, and explain why you deserve a pay increase while receiving growth feedback.</p>
          </div>
          <div class="info-card__grid">
            <div class="info-section info-section--values">
              <h3>Core Values</h3>
              <ul class="values-list">
                <li>Accountable</li>
                <li>Attention to Details</li>
                <li>Team Player</li>
                <li>Tactical Risk Taker</li>
                <li>Better than Yesterday</li>
                <li>Value Reputation</li>
              </ul>
            </div>
            <div class="info-section">
              <h3>Rating System</h3>
              <p>For each question, please select a rating using the scale below:</p>
              <div class="rating-badges">
                <span class="badge badge-gray">1 = Below Expectations</span>
                <span class="badge badge-green">2 = Meets Expectations</span>
                <span class="badge badge-gold">3 = Exceeds Expectations</span>
              </div>
              <p class="info-footnote">Attendance and punctuality (Question&nbsp;1) carry significant weight in determining your overall score.</p>
            </div>
            <div class="info-section info-section--wide">
              <h3>Review Process</h3>
              <dl class="info-meta">
                <div class="info-meta__item">
                  <dt>When</dt>
                  <dd>Reviews will be held throughout July.</dd>
                </div>
                <div class="info-meta__item">
                  <dt>Duration</dt>
                  <dd>Each review lasts ~20 minutes and begins on the half hour.</dd>
                </div>
              </dl>
              <h3 class="info-subtitle">How to Schedule</h3>
              <ol class="process-steps">
                <li><span>Complete this form</span></li>
                <li><span>Submit to your Department Manager</span></li>
                <li><span>Book a review time with your Manager on this site</span></li>
              </ol>
              <p class="info-footnote">Submit your form at least one week before your scheduled appointment.</p>
              <div class="info-callout"><strong>Important:</strong> Schedule outside your regular working hours. If you attend on your day off or outside your scheduled shift, message HR or your manager so payroll can add the time.</div>
              <h3 class="info-subtitle">Review Questions</h3>
              <p>Please answer clearly and concisely. Select your rating for each question.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="callout">Raises take effect on the first pay period in August.</div>
    </section>`
  },
  es:{
    home:'Inicio',reviews:'Reseñas',schedule:'Agenda',navTitle:'Revisiones Anuales de Empleados',navSubtitle:'Impulsa tu proceso de evaluación',
    welcomeTitle:'Bienvenido al Portal de Evaluaciones',
    welcomeMsg:'Seleccione una opción en la barra de navegación para ver sus evaluaciones o programar una reunión. Use el botón de idioma para cambiar entre inglés y español.',
    homeReviewsCardTitle:'Completa tu autoevaluación',
    homeReviewsCardBody:'Prepárate respondiendo cada pregunta con ejemplos claros y lleva un registro de tu progreso en un solo lugar.',
    homeScheduleCardTitle:'Reserva tu horario de revisión',
    homeScheduleCardBody:'Explora los horarios disponibles, verifica los ya reservados y asegura un momento que funcione para ti y tu gerente.',
    homeGuideCardTitle:'¿Necesitas ayuda?',
    homeGuideButton:'Abrir portal',
    comingSoon:'Próximamente...',userId:'ID de usuario',password:'Contraseña',login:'Iniciar sesión',logout:'Cerrar sesión',
    loginFail:'Error al iniciar sesión',invalidPwd:'Contraseña inválida.',
    noAccount:'Cuenta no encontrada. Por favor contacte a Sea Khun para ser agregado.',
    curWage:'Salario actual',newWage:'Nuevo salario',pctIncrease:'% Aumento:',
    finalExpTitle:'Expectativa de desempeño final',belowExp:'Debajo de las expectativas',meetsExp:'Cumple con las expectativas',exceedsExp:'Supera las expectativas',
    below:'Debajo',meets:'Cumple',exceeds:'Supera',
    notesPlaceholder:'Notas',contactQuestions:'Comuníquese con Sea Khun, gerente de HR/IT, si tiene alguna pregunta o inquietud.',empSignature:'Firma del empleado',mgrSignature:'Firma del gerente',signDate:'Fecha',submitReview:'Enviar revisión',
    employeeComments:'Comentarios del empleado',managerComments:'Comentarios del gerente',
    reviewSaved:'Revisión guardada',saveFailed:'No se pudo guardar la revisión',saving:'Guardando...',
    reviewSidebarTitle:'Tus reseñas',
    reviewSidebarSubtitle:'Sigue tu progreso y vuelve a ver los formularios enviados.',
    reviewListEmpty:'No hay revisiones disponibles.',
    reviewTypeSELF:'Autoevaluación',
    reviewTypeMANAGER:'Revisión del gerente',
    reviewTypeHR:'Revisión de RR. HH.',
    reviewStatusDRAFT:'Borrador',
    reviewStatusSUBMITTED:'Enviada',
    reviewStatusFINAL:'Finalizada',
    reviewYearLabel:'Año de revisión',
    reviewLastUpdated:'Última actualización',
    reviewFinalExpectation:'Expectativa final',
    reviewFinalNotSet:'Sin definir',
    reviewAssignedTo:'Empleado',
    reviewOwnedByYou:'Tú',
    scheduleBtn:'Agendar Reunión de Revisión',
    scheduleHeroTitle:'Reserva tu revisión',
    scheduleHeroSubtitle:'Elige un bloque de 30 minutos que funcione para ti y tu gerente.',
    scheduleCalendarTitle:'Elige un horario',
    scheduleCalendarSubtitle:'Toca cualquier espacio verde para reservarlo al instante. Los espacios rojos ya están ocupados y los azules son los que reservaste.',
    scheduleLegendAvailable:'Espacio disponible',
    scheduleLegendMine:'Reservado por ti',
    scheduleLegendBooked:'Reservado',
    scheduleNoBooking:'Todavía no has reservado tu revisión. Elige un horario disponible en el calendario para confirmarla.',
    scheduleNextBookingTitle:'Tu revisión está reservada',
    scheduleUpcomingLabel:'Próxima revisión',
    scheduleBookingHelp:'¿Necesitas hacer un cambio? Comunícate con tu gerente o con RR. HH.',
    scheduleManagerToolsTitle:'Herramientas de disponibilidad para gerentes',
    scheduleManagerSlotsTitle:'Disponibilidad publicada',
    scheduleManagerNoSlots:'Aún no has compartido disponibilidad. Usa el formulario de arriba para agregar bloques de 30 minutos.',
    scheduleBookConfirm:'¿Deseas reservar esta revisión el {date} a las {time} con {manager}?',
    scheduleBookSuccess:'¡Revisión reservada!',
    scheduleBookConflict:'Alguien acaba de reservar ese horario. Elige otro momento.',
    scheduleBookedLabel:'Reservado',
    scheduleAvailableLabel:'Disponible',
    scheduleBookedBy:'Reservado por',
    scheduleManagerLabel:'Gerente',
    scheduleViewOnly:'Este horario ya está ocupado.',
    scheduleAssignPrompt:'Ingresa el ID del empleado para asignar este horario:',
    scheduleAssignError:'Debes ingresar un ID de empleado.',
    cancel:'Cancelar',
    conflict:'Horario no disponible',
    selDate:'Seleccionar fecha',
    selTime:'Seleccionar hora',
    fromDate:'Fecha inicial',
    fromTime:'Hora inicial',
    toDate:'Fecha final',
    toTime:'Hora final',
    book:'Agendar',
    chooseTime:'Seleccione fecha y hora',
    bookOk:'Reunión programada',
    error:'Ocurrió un error',
    scheduleGuide:`<div class="callout"><h3 class="font-bold mb-1">Pautas de reserva y disponibilidad</h3><ul class="list-disc pl-4 space-y-1"><li><strong>Equipo de Producción</strong> – Reserve revisiones <strong>12:00 PM – 2:00 PM</strong> (después de producción). Estas horas tienen prioridad para la sala de conferencias.</li><li><strong>Conductores de Entrega</strong> – Trate de reservar <strong>los miércoles</strong> (día sin ruta).</li><li><strong>CSRs</strong> – Programe cualquier otro horario disponible que funcione para usted y su gerente.</li><li><strong>Una sala. Un turno. Un equipo.</strong> – Solo una reserva de <strong>30 minutos</strong>; no se permiten dobles reservas.</li></ul></div>`,
    compAdjustTitle:'Ajuste de compensación',
    saveSlotBtn:'Guardar',
    addSlotTitle:'Establecer disponibilidad',
    addSlotBtn:'Agregar horario',
    slotListTitle:'Horarios',
    slotsSaved:'horario(s) guardado(s)',
    availableShort:'Disponible',
    bookedShort:'Reservado',
    errorPast:'No se pueden agregar horarios en el pasado.',
    errorOverlap:'El horario se superpone con uno existente.',
    errorMissing:'Complete todos los campos.',
    errorInvalid:'Rango de tiempo inválido.',
    intro:`<section id="review-intro">
      <h1>Tu oportunidad para destacar</h1>
      <div class="intro-cards">
        <div class="info-card info-card--combined">
          <div class="info-card__header">
            <h2>Propósito</h2>
            <p>Destacar logros, vivir nuestros valores fundamentales y explicar por qué mereces un aumento mientras recibes comentarios para crecer.</p>
          </div>
          <div class="info-card__grid">
            <div class="info-section info-section--values">
              <h3>Valores fundamentales</h3>
              <ul class="values-list">
                <li>Responsabilidad</li>
                <li>Atención al detalle</li>
                <li>Trabajo en equipo</li>
                <li>Tomador de riesgos táctico</li>
                <li>Mejor que ayer</li>
                <li>Valorar la reputación</li>
              </ul>
            </div>
            <div class="info-section">
              <h3>Sistema de calificación</h3>
              <p>Para cada pregunta, seleccione una calificación usando la escala a continuación:</p>
              <div class="rating-badges">
                <span class="badge badge-gray">1 = Por debajo de las expectativas</span>
                <span class="badge badge-green">2 = Cumple con las expectativas</span>
                <span class="badge badge-gold">3 = Supera las expectativas</span>
              </div>
              <p class="info-footnote">La asistencia y la puntualidad (Pregunta&nbsp;1) tienen un peso significativo en su puntaje general.</p>
            </div>
            <div class="info-section info-section--wide">
              <h3>Proceso de revisión</h3>
              <dl class="info-meta">
                <div class="info-meta__item">
                  <dt>Cuándo</dt>
                  <dd>Las revisiones se realizarán durante todo julio.</dd>
                </div>
                <div class="info-meta__item">
                  <dt>Duración</dt>
                  <dd>Cada revisión dura ~20 minutos e inicia en la media hora.</dd>
                </div>
              </dl>
              <h3 class="info-subtitle">Cómo programar</h3>
              <ol class="process-steps">
                <li><span>Complete este formulario</span></li>
                <li><span>Entregue el formulario completo a su gerente de departamento</span></li>
                <li><span>Agende una cita con su gerente en este sitio</span></li>
              </ol>
              <p class="info-footnote">Envíe su formulario al menos una semana antes de su cita programada.</p>
              <div class="info-callout"><strong>Importante:</strong> Programe su revisión fuera de su horario laboral habitual. Si asiste en su día libre o fuera de su turno, avise a RR. HH. o a su gerente para que se agregue el tiempo a la nómina.</div>
              <h3 class="info-subtitle">Preguntas de revisión</h3>
              <p>Responda de forma clara y concisa. Seleccione su calificación para cada pregunta.</p>
            </div>
          </div>
        </div>
      </div>
      <div class="callout">Los aumentos entran en vigor en el primer periodo de pago de agosto.</div>
    </section>`
  }
};
function t(key){
  if(config[key]&&config[key][lang])return config[key][lang];
  if(translations[lang]&&translations[lang][key])return translations[lang][key];
  return key;
}
function startLoading(){
  document.body.style.background='#fff';
  const lb=document.getElementById('loadingBar');
  if(lb)lb.classList.remove('hidden');
  loadingReviews=true;
}
function stopLoading(){
  document.body.style.background='';
  const lb=document.getElementById('loadingBar');
  if(lb)lb.classList.add('hidden');
  loadingReviews=false;
}
function setMenuState(open){
  const items=document.getElementById('navItems');
  const toggle=document.getElementById('navToggle');
  if(items){
    items.classList.toggle('show',!!open);
  }
  if(toggle){
    toggle.setAttribute('aria-expanded',open?'true':'false');
  }
}
function closeMenu(){setMenuState(false);}
function show(id){
  const sections=document.querySelectorAll('section[data-view]');
  if((id==='reviews' || id==='schedule') && !user){
    pendingSection=id;
    sections.forEach(s=>s.classList.add('hidden'));
    document.getElementById('login').classList.remove('hidden');
    return;
  }
  document.getElementById('login').classList.add('hidden');
  closeMenu();
  sections.forEach(s=>s.classList.add('hidden'));
  if(id==='reviews'){
    startLoading();
    if(user){
      loadReviews();
      loadSavedReview();
    }
    loadQuestions();
  }else if(id==='schedule'){
    initCalendar();
    updateCalendarView();
    document.getElementById(id).classList.remove('hidden');
    if(user){
      loadAvailability();
    }
  }else{
    if(id==='home'){
      const list=document.getElementById('reviewsList');
      if(list)list.innerHTML='';
    }
    document.getElementById(id).classList.remove('hidden');
  }
}

function openSchedule(){
  closeMenu();
  show('schedule');
}
function applyTranslations(){
  document.querySelectorAll('[data-i18n-key]').forEach(el=>{
    const key=el.dataset.i18nKey;
    if(el.hasAttribute('data-i18n-placeholder'))el.placeholder=t(key);
    else if(el.hasAttribute('data-i18n-html'))el.innerHTML=t(key);
    else if(el.hasAttribute('data-i18n-alt'))el.alt=t(key);
    else el.textContent=t(key);
  });
  const toggle=document.getElementById('langToggle');
  if(toggle)toggle.checked=lang==='es';
  const loginBtn=document.getElementById('navLoginBtn');
  if(loginBtn)loginBtn.textContent=user?t('logout'):t('login');
}
function toggleMenu(){
  const items=document.getElementById('navItems');
  if(!items)return;
  const isOpen=!items.classList.contains('show');
  setMenuState(isOpen);
}
window.addEventListener('resize',()=>{
  if(window.innerWidth>=768){
    setMenuState(false);
  }
  updateCalendarView();
});
document.addEventListener('click',e=>{
  const items=document.getElementById('navItems');
  if(!items || !items.classList.contains('show')) return;
  const toggle=document.getElementById('navToggle');
  if((toggle && toggle.contains(e.target)) || items.contains(e.target)) return;
  setMenuState(false);
});
function init(){
  show('home');
  applyTranslations();
  document.getElementById('empSign').addEventListener('input',()=>updateSignDate('empSign','empSignDate'));
  document.getElementById('mgrSign').addEventListener('input',()=>updateSignDate('mgrSign','mgrSignDate'));
  loadQuestions();
  initCalendar();
  if(typeof google!=='undefined' && google.script && google.script.run){
    google.script.run.withSuccessHandler(c=>{
      config=c;
      applyTranslations();
      showDevButton();
    }).loadConfig();
  }else{
    showDevButton();
  }
}
function login(){
  const e=document.getElementById('userId').value;
  const p=document.getElementById('password').value;
  document.body.style.cursor='wait';
  startLoading();
  google.script.run
    .withSuccessHandler(r=>{
      document.body.style.cursor='';
      stopLoading();
      if(r.success){
        user=r.user;
        lang=user.lang;
        localStorage.setItem('lang',lang);
        document.getElementById('login').classList.add('hidden');
        document.getElementById('navLoginBtn').textContent=t('logout');
        applyTranslations();
        showDevButton();
        loadReviews();
        if(user.role==='DEV'){
          openDevPanel();
        }else{
          const target=pendingSection||'reviews';
          pendingSection=null;
          show(target);
        }
      }else{
        let msg='';
        if(r.error==='invalid_password')msg=t('invalidPwd');
        else if(r.error==='user_not_found')msg=t('noAccount');
        else msg=t('loginFail');
        alert(msg);
    }
    })
    .withFailureHandler(err=>{
      document.body.style.cursor='';
      stopLoading();
      alert(err.message||t('loginFail'));
    })
    .login(e,p);
}

function navLogin(){
  closeMenu();
  const loginDiv=document.getElementById('login');
  if(user){
    if(typeof google!==
      'undefined' && google.script && google.script.run){
      google.script.run.logout();
    }
    user=null;
    reviews=[];
    loginDiv.classList.add('hidden');
    document.getElementById('navLoginBtn').textContent=t('login');
    show('home');
  }else{
    loginDiv.classList.toggle('hidden');
    // hide dev panel when showing login
    const dev=document.getElementById('devPanel');
    if(dev)dev.classList.add('hidden');
  }
}

function toggleLang(){
  lang=document.getElementById('langToggle').checked?'es':'en';
  if(user) user.lang=lang;
  if(typeof google!=='undefined' && google.script && google.script.run){
    google.script.run.saveLang(lang);
  }
  localStorage.setItem('lang',lang);
  applyTranslations();
  renderReviews();
  renderQuestionList();
  if(calendar){
    calendar.setOption('locale',lang==='es'?'es':'en');
    renderCalendarSlots(calendarSlots);
  }
  renderBookingSummary(calendarSlots);
  renderSlotList(calendarSlots);
  if(user){
    loadAvailability();
  }
}
let reviews=[];
function loadReviews(){
  google.script.run.withSuccessHandler(r=>{
    reviews=r;
    renderReviews();
    fillSavedAnswers();
  }).listReviews();
}

function loadSavedReview(){
  if(!user || typeof google==='undefined' || !google.script || !google.script.run) return;
  google.script.run.withSuccessHandler(r=>{
    if(r){
      // replace existing saved review for selected year
      reviews=reviews.filter(rv=>!(rv.type==='SELF' && rv.employeeId==user.id && rv.data && Number(rv.data.year)==Number(selectedYear)));
      reviews.push(r);
    }
    fillSavedAnswers();
  }).getReviewByYear(selectedYear);
}
function renderReviews(){
  const container=document.getElementById('reviewsList');
  if(!container) return;
  container.innerHTML='';
  if(!Array.isArray(reviews) || reviews.length===0){
    const empty=document.createElement('p');
    empty.className='reviews-empty';
    empty.textContent=t('reviewListEmpty');
    container.appendChild(empty);
    return;
  }
  const sorted=[...reviews].sort((a,b)=>{
    const aDate=new Date(a.ts||0).getTime();
    const bDate=new Date(b.ts||0).getTime();
    return bDate-aDate;
  });
  sorted.forEach(rv=>{
    const card=document.createElement('article');
    card.className='card review-summary';

    const head=document.createElement('div');
    head.className='review-summary-head';

    const title=document.createElement('h3');
    title.className='review-summary-title';
    title.textContent=getReviewTypeLabel(rv);
    head.appendChild(title);

    const statusText=getReviewStatusLabel(rv.status);
    if(statusText){
      const statusBadge=document.createElement('span');
      statusBadge.className='review-status-badge';
      if(rv.status){
        statusBadge.classList.add('status-'+rv.status.toLowerCase());
      }
      statusBadge.textContent=statusText;
      head.appendChild(statusBadge);
    }

    card.appendChild(head);

    const meta=document.createElement('div');
    meta.className='review-summary-meta';

    addMeta(meta,t('reviewYearLabel'),getReviewYear(rv));

    if(rv.employeeId){
      const value=(user && rv.employeeId==user.id)?t('reviewOwnedByYou'):(rv.employeeName||rv.employeeId);
      addMeta(meta,t('reviewAssignedTo'),value);
    }

    const updatedLabel=getUpdatedLabel(rv.ts);
    if(updatedLabel){
      addMeta(meta,t('reviewLastUpdated'),updatedLabel);
    }

    addMeta(meta,t('reviewFinalExpectation'),getFinalExpectationValue(rv));

    if(meta.children.length){
      card.appendChild(meta);
    }

    container.appendChild(card);
  });

  function addMeta(wrapper,label,value){
    if(!value) return;
    const item=document.createElement('div');
    item.className='review-meta-item';
    const labelEl=document.createElement('span');
    labelEl.className='review-meta-label';
    labelEl.textContent=label;
    const valueEl=document.createElement('span');
    valueEl.className='review-meta-value';
    valueEl.textContent=value;
    item.appendChild(labelEl);
    item.appendChild(valueEl);
    wrapper.appendChild(item);
  }

  function getReviewYear(rv){
    const year=rv && rv.data && rv.data.year;
    return year?String(year):'';
  }

  function getUpdatedLabel(ts){
    if(!ts) return '';
    const date=new Date(ts);
    if(isNaN(date.getTime())) return '';
    return date.toLocaleString(lang==='es'?'es':'en');
  }

  function getFinalExpectationValue(rv){
    const final=rv && rv.data && rv.data.finalExpectation;
    if(!final || !final.result){
      return t('reviewFinalNotSet');
    }
    const map={below:'belowExp',meets:'meetsExp',exceeds:'exceedsExp'};
    const key=map[final.result];
    if(key){
      const val=t(key);
      return val===key?final.result:val;
    }
    return final.result;
  }

  function getReviewTypeLabel(rv){
    const type=(rv&&rv.type)||'';
    const key='reviewType'+type.toUpperCase();
    const translated=t(key);
    if(translated!==key) return translated;
    if(!type) return '';
    return type.charAt(0)+type.slice(1).toLowerCase();
  }

  function getReviewStatusLabel(status){
    if(!status) return '';
    const key='reviewStatus'+status.toUpperCase();
    const translated=t(key);
    if(translated!==key) return translated;
    return status.charAt(0)+status.slice(1).toLowerCase();
  }
}

function showDevButton(){
  const btn=document.getElementById('devBtn');
  if(!btn)return;
  btn.classList.remove('hidden');
  btn.disabled=false;
}

function devOAuthLogin(){
  if(typeof google==='undefined' || !google.script || !google.script.run){
    return;
  }
  startLoading();
  google.script.run
    .withSuccessHandler(r=>{
      stopLoading();
      if(r && r.authorized){
        user={userId:r.email,name:r.email,role:'DEV',lang:'en',id:r.email};
        document.getElementById('navLoginBtn').textContent=t('logout');
        openDevPanel();
      }else{
        document.getElementById('accessDenied').classList.remove('hidden');
      }
    })
    .withFailureHandler(err=>{
      stopLoading();
      alert(err.message||'Auth failed');
    })
    .authorizeDev();
}

function devLink(){
  if(user && user.role==='DEV'){
    openDevPanel();
  }else{
    devOAuthLogin();
  }
}

function openDevPanel(){
  if(!user || user.role!=='DEV'){
    document.getElementById('accessDenied').classList.remove('hidden');
    return;
  }
  document.querySelectorAll('body>section').forEach(s=>s.classList.add('hidden'));
  const loginDiv=document.getElementById('login');
  if(loginDiv)loginDiv.classList.add('hidden');
  const nu=document.getElementById('newUserModal');
  if(nu)nu.classList.add('hidden');
  const rp=document.getElementById('resetPwModal');
  if(rp)rp.classList.add('hidden');
  loadUsers();
  document.getElementById('devPanel').classList.remove('hidden');
}

let questions=[];
function loadQuestions(){
  if(typeof google==='undefined'||!google.script||!google.script.run){
    questions=defaultQuestions;
    renderQuestionList();
    return;
  }
  google.script.run
    .withSuccessHandler(q=>{
      questions=(q&&q.length)?q:defaultQuestions;
      renderQuestionList();
    })
    .withFailureHandler(err=>{
      console.error('loadQuestions failed',err);
      questions=defaultQuestions;
      renderQuestionList();
    })
    .getQuestions();
}
function renderQuestionList(){
  const qd=document.getElementById('questionList');
  if(!qd)return;
  qd.innerHTML='';
  questions.forEach(q=>{
    const div=document.createElement('div');
    div.className='card q';
    div.dataset.id=q.id;
    let html='<label class="question-title">'+q[lang]+'</label>';
    if(q.rating!==false){
      html+='<div class="rating-group">'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="1"> 1 - '+t('below')+'</label>'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="2"> 2 - '+t('meets')+'</label>'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="3"> 3 - '+t('exceeds')+'</label>'
        +'</div>';
    }else{
      html+='<input type="hidden" class="rating" value="">';
    }
    if(Array.isArray(q.extras)){
      q.extras.forEach(ex=>{
        let lbl=ex['label_'+lang]||ex.label;
        if(ex.type==='textarea' && ex.id!=='managerComments') lbl=t('employeeComments');
        html+='<label>'+lbl;
        if(ex.type==='textarea')html+='<textarea class="extra" data-sub="'+ex.id+'"></textarea>';
        else if(ex.type==='select'){
          html+='<select class="extra" data-sub="'+ex.id+'">';
          ex.options.forEach(o=>{html+='<option value="'+o+'">'+o+'</option>';});
          html+='</select>';
        }else {
          let attrs='';
          if(ex.type==='number' && (ex.id==='absences' || ex.id==='late')){
            attrs=' min="0" step="1"';
          }
          html+='<input type="'+ex.type+'" class="extra" data-sub="'+ex.id+'"'+attrs+'>';
        }
        html+='</label>';
      });
    }else if(q.extra==='textarea'){
      html+='<label>'+t('employeeComments')+'<textarea class="extra" data-sub="employeeComments"></textarea></label>';
    }else if(q.extra==='number'){
      html+='<input type="number" class="extra">';
    }
    html+='<label>'+t('managerComments')+'<textarea class="extra" data-sub="managerComments"></textarea></label>';
    div.innerHTML=html;
    qd.appendChild(div);
  });
  fillSavedAnswers();
  if(user&&user.role&&(['MANAGER','HR','DEV'].indexOf(user.role)!==-1)){
    document.getElementById('compAdjust').classList.remove('hidden');
  }
  if(loadingReviews){
    document.getElementById('reviews').classList.remove('hidden');
    stopLoading();
  }
  setupAutosave();
}

function fillSavedAnswers(){
  document.querySelectorAll('#questionList input.rating').forEach(r=>{r.checked=false;});
  document.querySelectorAll('#questionList .extra').forEach(e=>{e.value='';});
  document.querySelectorAll('#finalBlock input[name=finalExp]').forEach(r=>{r.checked=false;});
  document.getElementById('finalNotes').value='';
  document.getElementById('empSign').value='';
  document.getElementById('empSignDate').value='';
  document.getElementById('empSignDate').dataset.iso='';
  document.getElementById('mgrSign').value='';
  document.getElementById('mgrSignDate').value='';
  document.getElementById('mgrSignDate').dataset.iso='';
  currentReviewId=null;
  if(!user||!reviews||!reviews.length) return;
  const matches=reviews.filter(r=>
    r.type==='SELF' &&
    r.employeeId==user.id &&
    r.data && Number(r.data.year)==Number(selectedYear)
  );
  if(!matches.length) return;
  const rev=matches.sort((a,b)=>new Date(b.ts)-new Date(a.ts))[0];
  if(!rev.data || !rev.data.answers) return;
  currentReviewId=rev.id;
  const ans=rev.data.answers;
  Object.keys(ans).forEach(qid=>{
    const qDiv=document.querySelector('#questionList .q[data-id="'+qid+'"]');
    if(!qDiv) return;
    const val=ans[qid];
    if(val.score){
      const radio=qDiv.querySelector('input.rating[value="'+val.score+'"]');
      if(radio) radio.checked=true;
    }
    if(val.extra!==undefined){
      if(typeof val.extra==='object'){
        Object.keys(val.extra).forEach(k=>{
          const el=qDiv.querySelector('.extra[data-sub="'+k+'"]');
          if(el) el.value=val.extra[k];
        });
      }else{
        const el=qDiv.querySelector('.extra');
        if(el) el.value=val.extra;
      }
    }
  });
  if(rev.data.finalExpectation){
    const fe=rev.data.finalExpectation;
    if(fe.result){
      const r=document.querySelector('#finalBlock input[name=finalExp][value="'+fe.result+'"]');
      if(r) r.checked=true;
    }
    if(fe.notes) document.getElementById('finalNotes').value=fe.notes;
    if(fe.empSign){
      const empSignName=typeof fe.empSign==='object'?fe.empSign.name:fe.empSign;
      document.getElementById('empSign').value=empSignName||'';
      const empSignTs=typeof fe.empSign==='object'?fe.empSign.ts:null;
      if(empSignTs){
        const d=new Date(empSignTs);
        document.getElementById('empSignDate').value=d.toLocaleString();
        document.getElementById('empSignDate').dataset.iso=empSignTs;
      }
    }
    if(fe.mgrSign){
      const mgrSignName=typeof fe.mgrSign==='object'?fe.mgrSign.name:fe.mgrSign;
      document.getElementById('mgrSign').value=mgrSignName||'';
      const mgrSignTs=typeof fe.mgrSign==='object'?fe.mgrSign.ts:null;
      if(mgrSignTs){
        const d=new Date(mgrSignTs);
        document.getElementById('mgrSignDate').value=d.toLocaleString();
        document.getElementById('mgrSignDate').dataset.iso=mgrSignTs;
      }
    }
  }
}
function calcPct(){const c=parseFloat(document.getElementById('curWage').value||0);const n=parseFloat(document.getElementById('newWage').value||0);const pct=document.getElementById('pctInc');pct.textContent=c?(((n-c)/c)*100).toFixed(2):'0';}
function gatherAnswers(){
  const ans={};
  document.querySelectorAll('#questionList .q').forEach(d=>{
    const id=d.dataset.id;
    const ratingEl=d.querySelector('input.rating:checked, select.rating');
    const rating=ratingEl?ratingEl.value:'';
    const extraEls=d.querySelectorAll('.extra');
    let extra='';
    if(extraEls.length===1 && !extraEls[0].dataset.sub){
      extra=extraEls[0].value||'';
    }else if(extraEls.length>0){
      extra={};
      extraEls.forEach(e=>{extra[e.dataset.sub||'value']=e.value;});
    }
    ans[id]={score:rating,extra:extra};
  });
  return ans;
}
function gatherReviewData(){
  const answers=gatherAnswers();
  let comp=null;
  const adjBlock=document.getElementById('compAdjust');
  if(adjBlock&&!adjBlock.classList.contains('hidden')){
    comp={employeeId:user.id,current:document.getElementById('curWage').value,new:document.getElementById('newWage').value,pct:document.getElementById('pctInc').textContent};
  }
  const empDate=document.getElementById('empSignDate').dataset.iso;
  const mgrDate=document.getElementById('mgrSignDate').dataset.iso;
  const finalExp={
    result:document.querySelector('input[name=finalExp]:checked')?.value||'',
    notes:document.getElementById('finalNotes').value,
    empSign:{name:document.getElementById('empSign').value},
    mgrSign:{name:document.getElementById('mgrSign').value}
  };
  if(empDate) finalExp.empSign.ts=empDate;
  if(mgrDate) finalExp.mgrSign.ts=mgrDate;
  return {answers,comp,finalExp};
}

function updateSignDate(signId,dateId){
  const input=document.getElementById(signId);
  const dateField=document.getElementById(dateId);
  if(!input||!dateField) return;
  if(input.value.trim()){
    const now=new Date();
    dateField.value=now.toLocaleString();
    dateField.dataset.iso=now.toISOString();
  }else{
    dateField.value='';
    dateField.dataset.iso='';
  }
}

let autosaveTimeout;
let submitMsgTimeout;
function scheduleAutosave(){
  clearTimeout(autosaveTimeout);
  autosaveTimeout=setTimeout(autosaveReview,1000);
}
function autosaveReview(){
  if(!user) return;
  const data=gatherReviewData();
  const review={id:currentReviewId,employeeId:user.id,type:'SELF',status:'DRAFT',data:{year:selectedYear,answers:data.answers,finalExpectation:data.finalExp}};
  google.script.run.withFailureHandler(e=>console.error('autosave failed',e)).saveFullReview(review,data.comp);
}
function setupAutosave(){
  const form=document.getElementById('reviewForm');
  if(!form)return;
  const fields=form.querySelectorAll('input,textarea,select');
  fields.forEach(f=>{
    f.removeEventListener('input',scheduleAutosave);
    f.removeEventListener('change',scheduleAutosave);
    f.addEventListener('input',scheduleAutosave);
    f.addEventListener('change',scheduleAutosave);
  });
  window.addEventListener('beforeunload',autosaveReview);
}
function submitReview(){
  const data=gatherReviewData();
  const review={id:currentReviewId,employeeId:user.id,type:'SELF',status:'SUBMITTED',data:{year:selectedYear,answers:data.answers,finalExpectation:data.finalExp}};
  const msgEl=document.getElementById('submitMsg');
  msgEl.textContent='Saved';
  clearTimeout(submitMsgTimeout);
  submitMsgTimeout=setTimeout(()=>{msgEl.textContent='';},5000);
  google.script.run.withSuccessHandler(r=>{
    currentReviewId=r.id;
    loadReviews();
  }).saveFullReview(review,data.comp);
}

function loadUsers(){
  google.script.run.withSuccessHandler(renderUserTable).getAllUsers();
}

function renderUserTable(list){
  const body=document.querySelector('#userTable tbody');
  if(!body)return;
  body.innerHTML='';
  list.forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><span class="uid">${u.userId}</span><input class="uidEdit hidden border px-1" type="text" value="${u.userId}"></td>`+
      `<td><select class="roleSel" disabled><option>Employee</option><option>Manager</option><option>HR</option><option>DEV</option></select></td>`+
      `<td class="actions"><button type="button" class="editBtn" title="Edit">✏️</button>`+
      `<button type="button" class="saveBtn hidden" title="Save">💾</button>`+
      `<button type="button" class="cancelBtn hidden" title="Cancel">✖</button>`+
      `<button type="button" class="pwBtn" title="Change Password">🔑</button></td>`;
    tr.querySelector('.roleSel').value=u.role;
    tr.querySelector('.uid').onclick=()=>enableEdit(tr,u.userId);
    tr.querySelector('.editBtn').onclick=()=>enableEdit(tr,u.userId);
    tr.querySelector('.cancelBtn').onclick=()=>disableEdit(tr);
    tr.querySelector('.saveBtn').onclick=()=>saveRow(tr,u.userId);
    tr.querySelector('.pwBtn').onclick=()=>showResetPwModal(u.userId);
    body.appendChild(tr);
  });
}

function enableEdit(tr,id){
  tr.querySelector('.uid').classList.add('hidden');
  tr.querySelector('.uidEdit').classList.remove('hidden');
  tr.querySelector('.roleSel').disabled=false;
  tr.querySelector('.editBtn').classList.add('hidden');
  tr.querySelector('.saveBtn').classList.remove('hidden');
  tr.querySelector('.cancelBtn').classList.remove('hidden');
}

function disableEdit(tr){
  tr.querySelector('.uid').classList.remove('hidden');
  tr.querySelector('.uidEdit').classList.add('hidden');
  tr.querySelector('.roleSel').disabled=true;
  tr.querySelector('.editBtn').classList.remove('hidden');
  tr.querySelector('.saveBtn').classList.add('hidden');
  tr.querySelector('.cancelBtn').classList.add('hidden');
}

function saveRow(tr,oldId){
  const newId=tr.querySelector('.uidEdit').value.trim();
  const role=tr.querySelector('.roleSel').value;
  const after=()=>{disableEdit(tr);loadUsers();};
  if(newId!==oldId){
    google.script.run.withSuccessHandler(()=>{
      google.script.run.withSuccessHandler(after).updateUserRole(newId,role);
    }).withFailureHandler(err=>alert(err.message)).updateUserID(oldId,newId);
  }else{
    google.script.run.withSuccessHandler(after).withFailureHandler(err=>alert(err.message)).updateUserRole(oldId,role);
  }
}


function showNewUserModal(){
  document.getElementById('newUid').value='';
  document.getElementById('newRole').value='Employee';
  document.getElementById('newPw1').value='';
  document.getElementById('newPw2').value='';
  document.getElementById('newUserModal').classList.remove('hidden');
}

function addNewUser(){
  const uid=document.getElementById('newUid').value.trim();
  const r=document.getElementById('newRole').value;
  const p1=document.getElementById('newPw1').value;
  const p2=document.getElementById('newPw2').value;
  if(p1!==p2){alert('Passwords do not match');return;}
  google.script.run.withSuccessHandler(()=>{document.getElementById('newUserModal').classList.add('hidden');loadUsers();}).withFailureHandler(err=>alert(err.message)).addNewUser({userId:uid,password:p1,role:r});
}

function showResetPwModal(uid){
  resetUid=uid;
  document.getElementById('resetPw1').value='';
  document.getElementById('resetPw2').value='';
  document.getElementById('resetPwModal').classList.remove('hidden');
}

function resetPassword(){
  const p1=document.getElementById('resetPw1').value;
  const p2=document.getElementById('resetPw2').value;
  if(p1!==p2){alert('Passwords do not match');return;}
  google.script.run.withSuccessHandler(()=>{document.getElementById('resetPwModal').classList.add('hidden');loadUsers();}).withFailureHandler(err=>alert(err.message)).updateUserPassword(resetUid,p1);
}

function confirmClearReviews(){
  if(!confirm('Delete all review data?')) return;
  google.script.run
    .withSuccessHandler(()=>alert('All reviews deleted'))
    .withFailureHandler(err=>alert(err.message))
    .deleteAllReviews();
}

// ---- Modern Calendar Scheduling -----
let calendar;
let calendarSlots=[];
function getRole(){
  return user?String(user.role||'').toUpperCase():'';
}
function initCalendar(){
  const el=document.getElementById('calendar');
  if(!el) return;
  const fc=window.FullCalendar;
  if(!fc||typeof fc.Calendar!=='function'){
    console.error('FullCalendar library failed to load');
    return;
  }
  const initialView=window.innerWidth<768?'timeGridDay':'timeGridWeek';
  if(!calendar){
    const plugins=[
      fc.interactionPlugin,
      fc.dayGridPlugin,
      fc.timeGridPlugin,
      fc.listPlugin
    ].filter(Boolean);
    const options={
      initialView:initialView,
      locale:lang==='es'?'es':'en',
      headerToolbar:{start:'prev,next today',center:'title',end:'timeGridDay,timeGridWeek,dayGridMonth'},
      height:'auto',
      slotDuration:'00:30:00',
      slotMinTime:'07:00:00',
      slotMaxTime:'19:00:00',
      expandRows:true,
      nowIndicator:true,
      allDaySlot:false,
      eventTimeFormat:{hour:'numeric',minute:'2-digit'},
      eventClassNames:arg=>{
        const classes=['booking-event'];
        const status=arg.event.extendedProps.status;
        if(status==='open') classes.push('booking-open');
        if(status==='booked') classes.push('booking-booked');
        if(status==='mine') classes.push('booking-mine');
        if(arg.event.extendedProps.past) classes.push('booking-past');
        return classes;
      },
      eventClick:onCalendarEventClick
    };
    if(plugins.length){
      options.plugins=plugins;
    }
    calendar=new fc.Calendar(el,options);
  }else{
    calendar.setOption('initialView',initialView);
  }
  calendar.setOption('locale',lang==='es'?'es':'en');
  calendar.render();
  updateCalendarView();
}
function addAvailability(){
  const sd=document.getElementById('availFromDate').value;
  const st=document.getElementById('availFromTime').value;
  const ed=document.getElementById('availToDate').value;
  const et=document.getElementById('availToTime').value;
  if(!sd||!st||!ed||!et){showError(t('errorMissing'));return;}
  google.script.run.withSuccessHandler(res=>{
    loadAvailability();
    const n=(res.added||[]).length;
    if(n) showSnackbar(n+' '+t('slotsSaved'));
  }).withFailureHandler(err=>{
    showError(mapError(err));
  }).postAvailability({start:sd+'T'+st,end:ed+'T'+et});
}
function loadAvailability(){
  if(!user) return;
  if(typeof google==='undefined' || !google.script || !google.script.run) return;
  google.script.run
    .withSuccessHandler(slots=>{
      calendarSlots=Array.isArray(slots)?slots:[];
      renderCalendarSlots(calendarSlots);
      renderBookingSummary(calendarSlots);
      renderSlotList(calendarSlots);
    })
    .withFailureHandler(err=>{
      showError(mapError(err));
    })
    .getAvailability();
}
function renderCalendarSlots(slots){
  if(!calendar) return;
  calendar.removeAllEvents();
  const now=new Date();
  const myId=user?user.userId:null;
  (slots||[]).forEach(slot=>{
    const start=new Date(slot.start);
    const end=new Date(slot.end);
    if(isNaN(start)||isNaN(end)) return;
    const booked=!!slot.employeeId;
    const isMine=booked && slot.employeeId===myId;
    const status=isMine?'mine':(booked?'booked':'open');
    const past=end<now;
    const timeLabel=formatRange(slot.start,slot.end);
    let title=timeLabel;
    if(!booked) title+=' • '+(slot.userId||t('scheduleManagerLabel'));
    else if(isMine) title+=' • '+t('scheduleLegendMine');
    else title+=' • '+t('scheduleBookedLabel');
    const classes=['booking-event'];
    if(status==='open') classes.push('booking-open');
    if(status==='booked') classes.push('booking-booked');
    if(status==='mine') classes.push('booking-mine');
    if(past) classes.push('booking-past');
    calendar.addEvent({
      id:String(slot.id),
      start,
      end,
      title,
      classNames:classes,
      extendedProps:{slot,status,past}
    });
  });
}
function renderBookingSummary(slots){
  const list=document.getElementById('bookingList');
  const empty=document.getElementById('bookingEmpty');
  if(!list||!empty) return;
  list.innerHTML='';
  const myId=user?user.userId:null;
  if(!myId){
    empty.classList.remove('hidden');
    return;
  }
  const upcoming=(slots||[])
    .filter(s=>s.employeeId===myId)
    .filter(s=>new Date(s.end)>new Date())
    .sort((a,b)=>new Date(a.start)-new Date(b.start));
  if(upcoming.length===0){
    empty.classList.remove('hidden');
    return;
  }
  empty.classList.add('hidden');
  upcoming.slice(0,2).forEach(slot=>{
    const details=formatSlotDetails(slot);
    const item=document.createElement('div');
    item.className='booking-item';
    const title=document.createElement('h4');
    title.textContent=t('scheduleUpcomingLabel');
    item.appendChild(title);
    const timeEl=document.createElement('time');
    timeEl.dateTime=slot.start;
    timeEl.textContent=details.dateLabel;
    item.appendChild(timeEl);
    const range=document.createElement('span');
    range.textContent=details.timeLabel;
    item.appendChild(range);
    const manager=document.createElement('span');
    manager.textContent=`${t('scheduleManagerLabel')}: ${details.managerLabel}`;
    item.appendChild(manager);
    list.appendChild(item);
  });
}
function renderSlotList(slots){
  const tools=document.getElementById('managerTools');
  const list=document.getElementById('slotList');
  const slotCard=document.getElementById('slotCard');
  const empty=document.getElementById('managerNoSlots');
  if(!tools||!list||!slotCard) return;
  if(!user) return;
  const role=getRole();
  const isManager=role==='MANAGER'||role==='DEV';
  tools.classList.toggle('hidden',!isManager);
  if(!isManager) return;
  list.innerHTML='';
  slotCard.classList.remove('hidden');
  const mine=(slots||[])
    .filter(s=>s.userId===user.userId)
    .sort((a,b)=>new Date(a.start)-new Date(b.start));
  if(mine.length===0){
    if(empty) empty.classList.remove('hidden');
    return;
  }
  slotCard.classList.remove('hidden');
  if(empty) empty.classList.add('hidden');
  mine.forEach(slot=>{
    const details=formatSlotDetails(slot);
    const row=document.createElement('div');
    row.className='slot-row';
    if(slot.employeeId) row.classList.add('slot-row-booked');
    const range=document.createElement('span');
    range.className='slot-range';
    range.textContent=details.shortDate+' · '+details.timeLabel;
    row.appendChild(range);
    const status=document.createElement('span');
    status.className='slot-status';
    status.textContent=slot.employeeId?`${t('scheduleBookedBy')} ${slot.employeeId}`:t('scheduleAvailableLabel');
    row.appendChild(status);
    if(!slot.employeeId){
      const inp=document.createElement('input');
      inp.type='text';
      inp.className='slot-assign';
      inp.placeholder=t('userId');
      row.appendChild(inp);
      const btn=document.createElement('button');
      btn.type='button';
      btn.textContent=t('saveSlotBtn');
      btn.className='primary slot-save';
      btn.onclick=()=>saveSlot(slot.id,inp.value.trim(),inp);
      row.appendChild(btn);
    }
    list.appendChild(row);
  });
}
function saveSlot(id,val,inputEl){
  if(!val){
    showSnackbar(t('scheduleAssignError'));
    if(inputEl) inputEl.focus();
    return;
  }
  google.script.run
    .withSuccessHandler(()=>{
      showSnackbar(t('scheduleBookSuccess'));
      loadAvailability();
    })
    .withFailureHandler(err=>{
      showSnackbar(mapError(err));
    })
    .bookSlot({slotId:id,employeeId:val});
}
function formatSlotDetails(slot){
  const locale=lang==='es'?'es':'en';
  const start=new Date(slot.start);
  const end=new Date(slot.end);
  const dateLabel=isNaN(start)?'':start.toLocaleDateString(locale,{weekday:'long',month:'long',day:'numeric'});
  const shortDate=isNaN(start)?'':start.toLocaleDateString(locale,{weekday:'short',month:'short',day:'numeric'});
  const timeLabel=formatRange(slot.start,slot.end);
  return {dateLabel,shortDate,timeLabel,managerLabel:slot.userId||t('scheduleManagerLabel')};
}
function updateCalendarView(){
  if(!calendar) return;
  const desired=window.innerWidth<768?'timeGridDay':'timeGridWeek';
  if(calendar.view && calendar.view.type!==desired){
    calendar.changeView(desired);
  }
}
function onCalendarEventClick(info){
  if(!user){
    show('schedule');
    return;
  }
  const slot=info.event.extendedProps.slot;
  if(!slot) return;
  const role=getRole();
  if(slot.employeeId){
    if(slot.employeeId===user.userId){
      showSnackbar(t('scheduleLegendMine'));
    }else{
      showSnackbar(t('scheduleViewOnly'));
    }
    return;
  }
  if(role==='MANAGER'||role==='DEV'){
    const val=prompt(t('scheduleAssignPrompt'));
    if(val===null) return;
    const trimmed=val.trim();
    if(!trimmed){
      showSnackbar(t('scheduleAssignError'));
      return;
    }
    google.script.run
      .withSuccessHandler(res=>{
        if(res.status==='ok') showSnackbar(t('scheduleBookSuccess'));
        else if(res.status==='taken') showSnackbar(t('scheduleBookConflict'));
        else showSnackbar(t('error'));
        loadAvailability();
      })
      .withFailureHandler(err=>{
        showSnackbar(mapError(err));
        loadAvailability();
      })
      .bookSlot({slotId:slot.id,employeeId:trimmed});
    return;
  }
  const details=formatSlotDetails(slot);
  const confirmMsg=t('scheduleBookConfirm')
    .replace('{date}',details.dateLabel)
    .replace('{time}',details.timeLabel)
    .replace('{manager}',details.managerLabel);
  if(!confirm(confirmMsg)) return;
  google.script.run
    .withSuccessHandler(res=>{
      if(res.status==='ok') showSnackbar(t('scheduleBookSuccess'));
      else showSnackbar(t('scheduleBookConflict'));
      loadAvailability();
    })
    .withFailureHandler(err=>{
      showSnackbar(mapError(err));
      loadAvailability();
    })
    .bookSlot({slotId:slot.id,employeeId:user.userId});
}
function formatRange(start,end){
  const opts={hour:'numeric',minute:'2-digit'};
  const a=new Date(start).toLocaleTimeString(lang==='es'?'es':'en',opts);
  const b=new Date(end).toLocaleTimeString(lang==='es'?'es':'en',opts);
  return a+' \u2013 '+b;
}
function showSnackbar(msg){
  let bar=document.getElementById('snackbar');
  if(!bar) return;
  bar.textContent=msg;
  bar.classList.add('show');
  setTimeout(()=>bar.classList.remove('show'),3000);
}
function showError(msg){
  console.error(msg);
  const modal=document.getElementById('errorModal');
  const txt=document.getElementById('errorText');
  if(txt)txt.textContent=msg;
  if(modal)modal.classList.remove('hidden');
}
function closeError(){
  const modal=document.getElementById('errorModal');
  if(modal)modal.classList.add('hidden');
}
function mapError(err){
  const m=err&&err.message||'';
  if(m==='past') return t('errorPast');
  if(m==='overlap') return t('errorOverlap');
  if(m==='missing') return t('errorMissing');
  if(m==='invalid') return t('errorInvalid');
  return t('error');
}
document.addEventListener('DOMContentLoaded',init);
</script>
</head>
<body>
<header class="app-header">
  <div class="nav-bar">
    <div class="nav-brand">
      <img src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png" alt="Logo">
      <div class="brand-text">
        <span class="brand-title" data-i18n-key="navTitle">Employee Annual Reviews</span>
        <span class="brand-sub" data-i18n-key="navSubtitle">Empower your review journey</span>
      </div>
    </div>
    <button type="button" id="navToggle" class="nav-toggle material-icons" aria-expanded="false" aria-controls="navItems" onclick="toggleMenu()">menu</button>
    <div id="navItems" class="nav-items">
      <button type="button" onclick="show('home')" data-i18n-key="home">Home</button>
      <button type="button" onclick="show('reviews')" data-i18n-key="reviews">Reviews</button>
      <button type="button" onclick="openSchedule()" data-i18n-key="schedule">Schedule</button>
      <div class="lang-switch">
        <span>EN</span>
        <label class="switch"><input type="checkbox" id="langToggle" onchange="toggleLang()"><span class="slider"></span></label>
        <span>ES</span>
      </div>
      <button type="button" id="navLoginBtn" onclick="navLogin()" data-i18n-key="login">Login</button>
      <button type="button" id="devBtn" onclick="devLink()">Dev</button>
    </div>
  </div>
</header>
<div id="loadingBar" class="loading-bar hidden"><span></span></div>
<div id="snackbar"></div>
<div id="errorModal" class="modal hidden">
  <div class="bg-white rounded-xl p-6 w-80 space-y-4">
    <p id="errorText" class="text-center"></p>
    <button type="button" class="primary w-full" onclick="closeError()">OK</button>
  </div>
</div>
<main>
  <section id="home" class="hidden" data-view>
    <div class="home-hero">
      <h1 data-i18n-key="welcomeTitle">Welcome to the Employee Review Portal</h1>
      <p data-i18n-key="welcomeMsg">Select an option from the navigation bar to view your reviews or schedule a meeting. Use the language button to switch between English and Spanish.</p>
    </div>
    <div class="home-actions">
      <article class="home-card">
        <h2 data-i18n-key="homeReviewsCardTitle">Complete your self-review</h2>
        <p data-i18n-key="homeReviewsCardBody">Stay prepared by answering each question with clear examples and track your progress in one place.</p>
        <button type="button" onclick="show('reviews')" data-i18n-key="reviews">Reviews</button>
      </article>
      <article class="home-card">
        <h2 data-i18n-key="homeScheduleCardTitle">Reserve your review time</h2>
        <p data-i18n-key="homeScheduleCardBody">Browse available slots, see what’s already booked, and lock in a time that works for you and your manager.</p>
        <button type="button" onclick="openSchedule()" data-i18n-key="schedule">Schedule</button>
      </article>
      <article class="home-card secondary">
        <h2 data-i18n-key="homeGuideCardTitle">Need a hand?</h2>
        <p data-i18n-key="contactQuestions">Please contact Sea Khun HR/IT Manager with any questions or concerns.</p>
        <button type="button" onclick="if(user){show('reviews');}else{navLogin();}" data-i18n-key="homeGuideButton">Open portal</button>
      </article>
    </div>
  </section>
  <section id="reviews" class="hidden" data-view>
    <form id="reviewForm" onsubmit="submitReview();return false;">
      <div data-i18n-key="intro" data-i18n-html></div>
      <aside id="reviewSidebar" class="card review-sidebar">
        <div class="sidebar-head">
          <h2 data-i18n-key="reviewSidebarTitle">Your reviews</h2>
          <p data-i18n-key="reviewSidebarSubtitle">Track progress and revisit submitted forms.</p>
        </div>
        <div id="reviewsList"></div>
      </aside>
      <div id="questionList"></div>
      <div id="compAdjust" class="card hidden">
        <div class="card-title" data-i18n-key="compAdjustTitle">Compensation Adjustment</div>
        <label><span data-i18n-key="curWage">Current Wage</span><input type="number" id="curWage" oninput="calcPct()"></label>
        <label><span data-i18n-key="newWage">New Wage</span><input type="number" id="newWage" oninput="calcPct()"></label>
        <div><span data-i18n-key="pctIncrease">% Increase:</span> <span id="pctInc">0</span>%</div>
      </div>
      <div id="finalBlock" class="card">
        <p class="card-title" data-i18n-key="finalExpTitle">Final Performance Expectation</p>
        <label><input type="radio" name="finalExp" value="below"> <span data-i18n-key="belowExp">Below Expectations</span></label>
        <label><input type="radio" name="finalExp" value="meets"> <span data-i18n-key="meetsExp">Meets Expectations</span></label>
        <label><input type="radio" name="finalExp" value="exceeds"> <span data-i18n-key="exceedsExp">Exceeds Expectations</span></label>
        <label><span data-i18n-key="notesPlaceholder">Notes</span>
          <textarea id="finalNotes" data-i18n-key="notesPlaceholder" data-i18n-placeholder placeholder="Notes"></textarea>
        </label>
      </div>
      <div id="signaturesCard" class="card">
        <label>
          <span data-i18n-key="empSignature">Employee Signature</span>
          <input type="text" id="empSign" class="signature">
        </label>
        <input type="text" id="empSignDate" class="sign-date" readonly data-i18n-key="signDate" data-i18n-placeholder placeholder="Date">
        <label>
          <span data-i18n-key="mgrSignature">Manager Signature</span>
          <input type="text" id="mgrSign" class="signature">
        </label>
        <input type="text" id="mgrSignDate" class="sign-date" readonly data-i18n-key="signDate" data-i18n-placeholder placeholder="Date">
      </div>
      <div class="form-actions">
        <button class="primary" type="submit" data-i18n-key="submitReview">Submit Review</button>
        <button id="btnSchedule" class="primary secondary" type="button" onclick="show('schedule')" data-i18n-key="scheduleBtn"></button>
        <span id="submitMsg"></span>
      </div>
      <div class="form-footnote"><small data-i18n-key="contactQuestions">Please contact Sea Khun HR/IT Manager with any questions or concerns.</small></div>
    </form>
  </section>
  <section id="schedule" class="hidden" data-view>
    <div class="schedule-layout">
      <div class="card schedule-hero">
        <h2 data-i18n-key="scheduleHeroTitle">Book your review</h2>
        <p data-i18n-key="scheduleHeroSubtitle">Choose a 30-minute slot that works for both you and your manager.</p>
      </div>
      <div class="schedule-columns">
        <aside class="schedule-sidebar">
          <div class="card" id="bookingSummary">
            <h3 data-i18n-key="scheduleNextBookingTitle">Your review is booked</h3>
            <div id="bookingList" class="booking-list"></div>
            <p id="bookingEmpty" class="booking-empty" data-i18n-key="scheduleNoBooking">You haven’t reserved a review yet. Choose an available time on the calendar to lock it in.</p>
            <p class="booking-help" data-i18n-key="scheduleBookingHelp">Need to make a change? Contact your manager or HR for help.</p>
          </div>
          <div class="card" id="guideCard">
            <div data-i18n-key="scheduleGuide" data-i18n-html></div>
          </div>
          <div id="managerTools" class="card hidden manager-tools">
            <div>
              <div class="card-title" data-i18n-key="scheduleManagerToolsTitle">Manager availability tools</div>
            </div>
            <div id="availForm" class="availability-form">
              <div class="card-title" data-i18n-key="addSlotTitle">Set Availability</div>
              <label><span data-i18n-key="fromDate">Start Date</span>
                <input type="date" id="availFromDate">
              </label>
              <label><span data-i18n-key="fromTime">Start Time</span>
                <input type="time" id="availFromTime" step="1800">
              </label>
              <label><span data-i18n-key="toDate">End Date</span>
                <input type="date" id="availToDate">
              </label>
              <label><span data-i18n-key="toTime">End Time</span>
                <input type="time" id="availToTime" step="1800">
              </label>
              <button class="primary" type="button" onclick="addAvailability()" data-i18n-key="addSlotBtn">Add Slot</button>
              <div id="availMsg"></div>
            </div>
            <div id="slotCard" class="manager-slots hidden">
              <div class="card-title" data-i18n-key="scheduleManagerSlotsTitle">Posted availability</div>
              <div id="slotList"></div>
              <p id="managerNoSlots" class="booking-empty hidden" data-i18n-key="scheduleManagerNoSlots">You haven’t shared any availability yet. Use the form above to add 30-minute blocks.</p>
            </div>
          </div>
        </aside>
        <div id="calendarWrapper" class="card calendar-card">
          <div class="calendar-head">
            <h3 data-i18n-key="scheduleCalendarTitle">Pick a time that works</h3>
            <p data-i18n-key="scheduleCalendarSubtitle">Tap any green slot to instantly reserve it. Gray slots are already taken.</p>
            <div class="booking-legend">
              <span><span class="booking-dot available"></span><span data-i18n-key="scheduleLegendAvailable">Open slot</span></span>
              <span><span class="booking-dot mine"></span><span data-i18n-key="scheduleLegendMine">Booked by you</span></span>
              <span><span class="booking-dot booked"></span><span data-i18n-key="scheduleLegendBooked">Booked</span></span>
            </div>
          </div>
          <div id="calendar" class="booking-calendar"></div>
        </div>
      </div>
    </div>
  </section>
</main>
<section id="devPanel" class="hidden fixed inset-0 p-4 pt-16 overflow-auto bg-black/30 flex items-start justify-center">
  <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-3xl">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold">Developer Console</h3>
      <div class="flex items-center gap-4">
        <button type="button" class="text-red-600" onclick="confirmClearReviews()">Clear Reviews</button>
        <button onclick="document.getElementById('devPanel').classList.add('hidden')">✖</button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table id="userTable">
        <thead><tr><th>UserID</th><th>Role</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <button type="button" id="addUserFab" class="fixed bottom-6 right-6 bg-emerald-600 text-white rounded-full w-12 h-12 shadow-lg text-xl" onclick="showNewUserModal()" title="Add New User">+</button>
  </div>
  <div id="newUserModal" class="modal hidden">
    <div class="bg-white rounded-xl p-6 w-80 space-y-4">
      <h4 class="text-lg font-semibold text-center">Add User</h4>
      <input id="newUid" class="w-full border px-2 py-1" placeholder="UserID">
      <select id="newRole" class="w-full border px-2 py-1">
        <option>Employee</option><option>Manager</option><option>HR</option><option>DEV</option>
      </select>
      <input id="newPw1" type="password" class="w-full border px-2 py-1" placeholder="Password">
      <input id="newPw2" type="password" class="w-full border px-2 py-1" placeholder="Confirm Password">
      <div class="flex justify-between">
        <button type="button" class="primary" onclick="addNewUser()">Save</button>
        <button type="button" onclick="document.getElementById('newUserModal').classList.add('hidden')">Cancel</button>
      </div>
    </div>
  </div>
  <div id="resetPwModal" class="modal hidden">
    <div class="bg-white rounded-xl p-6 w-80 space-y-4">
      <h4 class="text-lg font-semibold text-center">Reset Password</h4>
      <input id="resetPw1" type="password" class="w-full border px-2 py-1" placeholder="New Password">
      <input id="resetPw2" type="password" class="w-full border px-2 py-1" placeholder="Confirm Password">
      <div class="flex justify-between">
        <button type="button" class="primary" onclick="resetPassword()">Save</button>
        <button type="button" onclick="document.getElementById('resetPwModal').classList.add('hidden')">Cancel</button>
      </div>
    </div>
  </div>
</section>
<section id="accessDenied" class="hidden fixed inset-0 flex items-center justify-center bg-white/90">
  <div class="bg-white rounded-xl shadow-xl p-8 text-center space-y-4">
    <h3 class="text-xl font-semibold">Access Denied</h3>
    <p>You are not authorized to use this console.</p>
    <button type="button" class="primary" onclick="document.getElementById('accessDenied').classList.add('hidden')">Close</button>
  </div>
</section>
<form id="login" class="hidden" onsubmit="login();return false;">
  <div class="card-like">
    <img src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png" alt="Logo">
    <h1 data-i18n-key="navTitle">Employee Annual Reviews</h1>
    <label>
      <span data-i18n-key="userId">User ID</span>
      <input type="text" id="userId" data-i18n-key="userId" data-i18n-placeholder>
    </label>
    <label>
      <span data-i18n-key="password">Password</span>
      <input type="password" id="password" data-i18n-key="password" data-i18n-placeholder>
    </label>
    <button class="primary" type="submit" data-i18n-key="login">Login</button>
  </div>
</form>
</body>
</html>
