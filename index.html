<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Employee Reviews</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Dancing+Script&amp;display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css">
<script type="module">import {Calendar} from "https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/+esm";window.FullCalendar={Calendar};</script>
<style>
:root{
  --emerald-50:#f0f8f3;
  --emerald-100:#e3f4ea;
  --emerald-600:#0A5C30;
  --emerald-700:#084725;
  --emerald-800:#06371f;
  --gold-400:#C9A14A;
  --gray-100:#f6f8fa;
  --gray-200:#e5e7eb;
  --gray-400:#94a3b8;
  --gray-600:#475569;
  --surface:#ffffff;
  --shadow:0 18px 36px rgba(10,92,48,0.12);
}
*,*::before,*::after{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Inter',Roboto,Arial,sans-serif;
  line-height:1.6;
  background:linear-gradient(135deg,#f6f8fa 0%,#eaf4ff 100%);
  color:#1f2933;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
h1,h2,h3,h4{
  font-family:'Inter',Arial,sans-serif;
  color:var(--emerald-700);
  margin:0;
}
h1{font-size:clamp(1.75rem,4vw,2.5rem);}
h2{font-size:clamp(1.25rem,3vw,1.75rem);}
main{flex:1;width:100%;}
.app-header{
  background:var(--emerald-600);
  color:#fff;
  position:sticky;
  top:0;
  z-index:70;
  box-shadow:0 16px 40px rgba(8,71,37,0.32);
}
.nav-bar{
  position:relative;
  width:min(1100px,100%);
  margin:0 auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:1rem;
  padding:0.75rem clamp(1.25rem,4vw,2.75rem);
}
.nav-brand{
  display:flex;
  align-items:center;
  gap:0.9rem;
}
.nav-brand img{
  width:3.5rem;
  height:3.5rem;
  object-fit:contain;
  filter:drop-shadow(0 10px 18px rgba(0,0,0,0.25));
}
.brand-text{display:flex;flex-direction:column;gap:0.15rem;}
.brand-title{font-size:1.05rem;font-weight:600;line-height:1.2;letter-spacing:0.01em;}
.brand-sub{font-size:0.8rem;opacity:0.75;}
.nav-toggle{
  background:rgba(255,255,255,0.1);
  border:1px solid rgba(255,255,255,0.25);
  border-radius:0.9rem;
  color:#fff;
  width:44px;
  height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  transition:background .2s ease,transform .2s ease;
}
.nav-toggle:hover{background:rgba(255,255,255,0.22);}
.nav-toggle:active{transform:scale(0.96);}
.nav-items{
  position:absolute;
  left:0;
  right:0;
  top:100%;
  display:flex;
  flex-direction:column;
  gap:0.75rem;
  background:var(--emerald-700);
  padding:1rem clamp(1.25rem,5vw,2.5rem);
  transform:scaleY(0);
  transform-origin:top;
  transition:transform .25s ease,opacity .25s ease;
  opacity:0;
  pointer-events:none;
  border-bottom-left-radius:1.25rem;
  border-bottom-right-radius:1.25rem;
  box-shadow:0 22px 36px rgba(8,71,37,0.4);
}
.nav-items.show{
  transform:scaleY(1);
  opacity:1;
  pointer-events:auto;
}
.nav-items button{
  background:none;
  border:none;
  color:#fff;
  font-size:1rem;
  font-weight:500;
  padding:0.5rem 0;
  text-align:left;
  display:flex;
  align-items:center;
  gap:0.4rem;
  cursor:pointer;
  transition:opacity .2s ease;
}
.nav-items button:hover{opacity:0.8;}
.lang-switch{display:flex;align-items:center;gap:0.35rem;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;}
.switch{position:relative;display:inline-block;width:42px;height:24px;}
.switch input{opacity:0;width:0;height:0;}
.slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#d1d5db;transition:.4s;border-radius:9999px;}
.slider:before{position:absolute;content:"";height:20px;width:20px;left:2px;bottom:2px;background:white;transition:.4s;border-radius:50%;box-shadow:0 4px 10px rgba(15,23,42,0.25);}
.switch input:checked + .slider{background:#059669;}
.switch input:checked + .slider:before{transform:translateX(18px);}
.hidden{display:none !important;}
section[data-view]{
  width:min(1100px,100%);
  margin:0 auto;
  padding:clamp(1.75rem,4vw,3rem) clamp(1.25rem,4vw,2.75rem);
  display:flex;
  flex-direction:column;
  gap:1.5rem;
}
.home-hero{
  display:flex;
  flex-direction:column;
  gap:0.75rem;
}
.home-actions{
  display:grid;
  gap:1rem;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
}
.home-card{
  background:var(--surface);
  padding:1.5rem;
  border-radius:1.25rem;
  box-shadow:var(--shadow);
  display:flex;
  flex-direction:column;
  gap:0.9rem;
}
.home-card p{margin:0;color:var(--gray-600);}
.home-card button{
  align-self:flex-start;
  border:none;
  border-radius:9999px;
  padding:0.65rem 1.25rem;
  font-weight:600;
  font-size:0.95rem;
  cursor:pointer;
  background:var(--emerald-600);
  color:#fff;
  transition:transform .2s ease,box-shadow .2s ease;
}
.home-card button:hover{transform:translateY(-1px);box-shadow:0 12px 18px rgba(10,92,48,0.18);}
.home-card.secondary button{background:transparent;color:var(--emerald-700);border:1px solid rgba(10,92,48,0.25);}
.home-card.secondary button:hover{background:var(--emerald-50);box-shadow:none;}
.card{
  background:var(--surface);
  border-radius:1.25rem;
  box-shadow:var(--shadow);
  padding:clamp(1.25rem,3vw,1.75rem);
  display:flex;
  flex-direction:column;
  gap:1rem;
}
#reviewForm{
  display:flex;
  flex-direction:column;
  gap:1.5rem;
}
.question-title{font-size:1.15rem;font-weight:600;color:var(--emerald-700);}
.card-title{font-weight:600;font-size:1rem;color:var(--emerald-700);}
label{
  display:flex;
  flex-direction:column;
  gap:0.35rem;
  font-size:0.95rem;
  color:#1f2937;
  font-weight:500;
}
input,textarea,select{
  font:inherit;
  border-radius:0.85rem;
  border:1px solid var(--gray-200);
  background:#fff;
  padding:0.65rem 0.9rem;
  transition:border .2s ease,box-shadow .2s ease;
  width:100%;
}
input:focus,textarea:focus,select:focus{
  outline:none;
  border-color:rgba(10,92,48,0.45);
  box-shadow:0 0 0 3px rgba(10,92,48,0.18);
}
textarea{min-height:140px;resize:vertical;}
input[type=radio],input[type=checkbox]{width:auto;padding:0;border-radius:999px;}
.signature{font-family:'Dancing Script',cursive;font-size:1.35rem;}
.sign-date{width:auto;max-width:240px;align-self:flex-start;}
.rating-group{
  display:flex;
  flex-direction:column;
  gap:0.65rem;
  padding-top:0.5rem;
}
.rating-group label{
  display:flex;
  align-items:center;
  gap:0.6rem;
  flex-wrap:wrap;
  border:1px solid rgba(10,92,48,0.2);
  border-radius:0.85rem;
  padding:0.6rem 0.9rem;
  font-weight:500;
}
.rating-group input{accent-color:var(--emerald-600);}
#questionList{display:flex;flex-direction:column;gap:1.25rem;}
#reviewsList{display:grid;gap:1rem;}
.callout{
  background:rgba(201,161,74,0.12);
  border-left:4px solid var(--gold-400);
  border-radius:0.75rem;
  padding:1rem 1.25rem;
  color:#4b5563;
}
.rating-badges{display:flex;flex-wrap:wrap;gap:0.5rem;}
.badge{display:inline-flex;align-items:center;justify-content:center;padding:0.35rem 0.85rem;border-radius:999px;font-size:0.85rem;font-weight:600;color:#fff;}
.badge-gray{background:#6b7280;}
.badge-green{background:var(--emerald-600);}
.badge-gold{background:var(--gold-400);color:#1f2937;}
.process{display:flex;flex-wrap:wrap;align-items:center;gap:0.5rem;font-size:0.95rem;color:#374151;}
.process svg{width:12px;height:12px;stroke:var(--emerald-700);stroke-width:2;}
#review-intro{
  background:linear-gradient(135deg,rgba(255,255,255,0.95),rgba(235,250,243,0.95));
  border-radius:1.5rem;
  padding:clamp(1.5rem,4vw,2.25rem);
  display:flex;
  flex-direction:column;
  gap:1.5rem;
}
#review-intro h1{text-align:center;color:var(--emerald-700);font-weight:700;}
#review-intro .intro-cards{display:grid;gap:1rem;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));}
#review-intro .info-card{background:#fff;border-radius:1rem;box-shadow:0 12px 30px rgba(6,55,31,0.08);padding:1.25rem;display:flex;flex-direction:column;gap:0.75rem;}
.values-list{list-style:none;padding:0;margin:0;display:flex;flex-wrap:wrap;gap:0.5rem;}
.values-list li{background:var(--emerald-600);color:#fff;padding:0.35rem 0.9rem;border-radius:999px;font-size:0.85rem;}
.form-actions{
  display:flex;
  flex-wrap:wrap;
  gap:0.75rem;
  align-items:center;
}
.form-footnote{margin-left:auto;font-size:0.85rem;color:var(--gray-600);text-align:right;}
.form-footnote small{color:inherit;}
button.primary{
  background:var(--emerald-600);
  color:#fff;
  border:none;
  border-radius:9999px;
  padding:0.75rem 1.5rem;
  font-size:1rem;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 12px 22px rgba(10,92,48,0.18);
  transition:transform .2s ease,box-shadow .2s ease;
}
button.primary:hover{transform:translateY(-1px);box-shadow:0 18px 28px rgba(10,92,48,0.22);}
button.primary:active{transform:translateY(0);box-shadow:0 8px 18px rgba(10,92,48,0.2);}
button.secondary{
  background:transparent;
  color:var(--emerald-700);
  border:1px solid rgba(10,92,48,0.3);
  box-shadow:none;
}
button.secondary:hover{background:var(--emerald-50);box-shadow:none;}
#submitMsg{font-weight:600;color:var(--emerald-700);}
.loading-bar{height:4px;background:rgba(15,118,110,0.12);position:sticky;top:0;z-index:60;overflow:hidden;}
.loading-bar span{display:block;height:100%;background:var(--emerald-600);width:100%;animation:loadAnim 1.2s linear infinite;}
@keyframes loadAnim{from{transform:translateX(-100%);}to{transform:translateX(100%);}}
#snackbar{position:fixed;bottom:1.5rem;left:50%;transform:translateX(-50%);background:#1f2937;color:#fff;padding:0.75rem 1.5rem;border-radius:999px;opacity:0;transition:opacity .3s ease,transform .3s ease;z-index:80;}
#snackbar.show{opacity:1;transform:translate(-50%,0);}
#scheduleFlex{display:grid;gap:1.25rem;}
.schedule-form{display:flex;flex-direction:column;gap:1.25rem;}
#calendarWrapper{min-height:380px;}
#calendar{min-height:340px;}
#slotList{display:flex;flex-direction:column;gap:0.5rem;max-height:260px;overflow-y:auto;padding-right:0.35rem;}
#availMsg{font-size:0.85rem;color:var(--emerald-700);}
.slot-row{display:flex;flex-wrap:wrap;align-items:center;gap:0.5rem 0.75rem;justify-content:flex-start;padding:0.75rem 0.9rem;border:1px solid var(--gray-200);border-radius:0.85rem;background:#fff;box-shadow:0 8px 18px rgba(15,23,42,0.08);}
.slot-row-booked{background:var(--emerald-100);border-color:rgba(10,92,48,0.25);}
.slot-range{flex:1 1 100%;font-weight:600;color:var(--emerald-700);}
.slot-assign{flex:1 1 160px;max-width:220px;}
.slot-save{padding:0.45rem 1rem;font-size:0.85rem;box-shadow:none;margin-left:auto;}
.slot-save:hover{box-shadow:0 10px 20px rgba(10,92,48,0.16);}
.calendar{width:100%;border-collapse:collapse;font-size:0.9rem;}
.calendar th,.calendar td{border:1px solid var(--gray-200);padding:0.75rem;vertical-align:top;background:#fff;}
.calendar th{background:var(--emerald-100);color:var(--emerald-800);text-align:left;font-weight:600;}
.calendar td.disabled{background:var(--gray-100);color:var(--gray-400);}
.calendar .date-num{font-weight:600;margin-bottom:0.4rem;display:block;color:var(--emerald-700);}
.calendar .slot{margin-top:0.3rem;padding:0.35rem 0.55rem;border-radius:0.65rem;font-size:0.75rem;cursor:pointer;display:inline-flex;gap:0.35rem;align-items:center;}
.calendar .slot.available{background:#d1fae5;color:#047857;}
.calendar .slot.booked{background:#e5e7eb;color:#6b7280;cursor:not-allowed;}
.calendar .slot.mine{background:var(--emerald-600);color:#fff;}
.calendar .slot:hover{box-shadow:0 6px 14px rgba(15,118,110,0.15);}
#devPanel{z-index:70;}
#devPanel table{width:100%;border-collapse:collapse;font-size:0.95rem;}
#devPanel th,#devPanel td{padding:0.75rem;border-bottom:1px solid var(--gray-200);text-align:left;}
#devPanel th{background:var(--emerald-100);color:var(--emerald-800);}
#devPanel .modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.45);z-index:80;}
#devPanel .modal.hidden{display:none;}
.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.4);z-index:80;}
.modal.hidden{display:none;}
#errorModal .card,#devPanel .modal .card{box-shadow:0 18px 32px rgba(15,23,42,0.25);}
#addUserFab{z-index:90;}
#accessDenied{z-index:90;}
#login{
  background:linear-gradient(135deg,#f6f8fa 0%,#eaf4ff 100%);
  min-height:calc(100vh - 64px);
  display:flex;
  align-items:center;
  justify-content:center;
  padding:clamp(2rem,6vw,4rem);
}
#login .card-like{
  background:rgba(255,255,255,0.9);
  border-radius:1.5rem;
  box-shadow:0 32px 60px rgba(15,23,42,0.18);
  padding:clamp(1.75rem,4vw,2.75rem);
  display:flex;
  flex-direction:column;
  gap:1.25rem;
  width:min(420px,100%);
}
#login img{height:100px;object-fit:contain;}
#login button.primary{width:100%;}
#submitMsg{min-width:120px;}
@media(min-width:768px){
  .nav-toggle{display:none;}
  .nav-items{
    position:static;
    transform:none;
    opacity:1;
    pointer-events:auto;
    flex-direction:row;
    align-items:center;
    gap:1.25rem;
    background:transparent;
    padding:0;
    box-shadow:none;
    border-radius:0;
  }
  .nav-items button{
    padding:0.55rem 1rem;
    border-radius:9999px;
    background:rgba(255,255,255,0.12);
  }
  .nav-items button:hover{opacity:1;background:rgba(255,255,255,0.22);}
  #scheduleFlex{grid-template-columns:280px 1fr;align-items:start;}
}
@media(min-width:1024px){
  #scheduleFlex{grid-template-columns:320px 1fr;}
  #calendarWrapper{padding:1rem 1.25rem;}
}
@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important;scroll-behavior:auto !important;}
}
</style>
<script>
let user=null,config={},lang=localStorage.getItem('lang')||'en';
let loadingReviews=false;
let pendingSection=null;
let currentReviewId=null;
let selectedYear=new Date().getFullYear();
let resetUid=null;

const defaultQuestions=[
  {id:'attendance',en:'Attendance & Punctuality',es:'Asistencia y Puntualidad',extras:[
    {id:'absences',label:'Absences without notice (days)',label_es:'Ausencias sin aviso (d√≠as)',type:'number'},
    {id:'late',label:'Late arrivals (days)',label_es:'Llegadas tarde (d√≠as)',type:'number'},
    {id:'employeeComments',label:"Employee's Comments",label_es:'Comentarios del empleado',type:'textarea'}]},
  {id:'performance',en:'Performance Improvements: What did you do more, better, or more efficiently last year, up till now?',es:'Mejoras de rendimiento',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'values',en:'Living Our Core Values: How have you embodied our core values? Provide specific examples.',es:'Vivir nuestros valores',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'growth',en:'Personal Growth: How did you improve your knowledge or skills last year, up till now?',es:'Crecimiento personal',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'learning',en:'Learning New Skills: Did you take or create opportunities to learn a new skill or enhance an existing one?',es:'Aprendizaje de nuevas habilidades',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'team',en:'Team Support: How did you support your teammates in developing their skills?',es:'Apoyo al equipo',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'flexibility',en:'Flexibility: When asked to cover for others, did you agree? Share an example.',es:'Flexibilidad',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'initiative',en:'Initiative: Describe a time you proactively improved a process or solved a problem without being asked.',es:'Iniciativa',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'proactive',en:'Proactive Contributions: How did you proactively use downtime to tackle additional tasks?',es:'Contribuciones proactivas',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'innovation',en:'Innovation & Process Improvement: Have you suggested or implemented improvements to our processes, services, or workplace? Describe your idea and its impact.',es:'Innovaci\u00f3n y mejora de procesos',extras:[{id:'employeeComments',type:'textarea'}]},
  {id:'crossshadow',en:'Cross Shadowing Program Participation',es:'Programa Cross Shadowing',rating:false,extras:[
    {id:'participation',label:'Did you participate? (Yes/No/Partial)',label_es:'¬øParticipaste? (S√≠/No/Parcial)',type:'select',options:['Yes','No','Partial']},
    {id:'employeeComments',label:"Employee's Comments",label_es:'Comentarios del empleado',type:'textarea'}]},
  {id:'future',en:'Future Interests: Is there another role or skill you\u2019d like to explore in the future?',es:'Intereses futuros',rating:false,extras:[{id:'employeeComments',type:'textarea'}]}
];
const translations={
  en:{
    home:'Home',reviews:'Reviews',schedule:'Schedule',navTitle:'Employee Annual Reviews',navSubtitle:'Empower your review journey',
    welcomeTitle:'Welcome to the Employee Review Portal',
    welcomeMsg:'Select an option from the navigation bar to view your reviews or schedule a meeting. Use the language button to switch between English and Spanish.',
    homeReviewsCardTitle:'Complete your self-review',
    homeReviewsCardBody:'Stay prepared by answering each question with clear examples and track your progress in one place.',
    homeScheduleCardTitle:'Reserve your review time',
    homeScheduleCardBody:'Browse available slots, see what\'s already booked, and lock in a time that works for you and your manager.',
    homeGuideCardTitle:'Need a hand?',
    homeGuideButton:'Open portal',
    comingSoon:'Coming soon...',userId:'User ID',password:'Password',login:'Login',logout:'Logout',
    loginFail:'Login failed',invalidPwd:'Invalid password.',
    noAccount:'Account not found. Please reach out to Sea Khun to be added.',
    curWage:'Current Wage',newWage:'New Wage',pctIncrease:'% Increase:',
    finalExpTitle:'Final Performance Expectation',belowExp:'Below Expectations',meetsExp:'Meets Expectations',exceedsExp:'Exceeds Expectations',
    below:'Below',meets:'Meets',exceeds:'Exceeds',
    notesPlaceholder:'Notes',contactQuestions:'Please contact Sea Khun HR/IT Manager with any questions or concerns.',empSignature:'Employee Signature',mgrSignature:'Manager Signature',signDate:'Date',submitReview:'Submit Review',
    employeeComments:"Employee's Comments",managerComments:"Manager's Comments",
    reviewSaved:'Review saved',saveFailed:'Failed to save review',saving:'Saving...',
    scheduleBtn:'Schedule Review Meeting',
    bookPrompt:'Book this time?',
    cancel:'Cancel',
    conflict:'Slot already booked',
    selDate:'Select Date',
    selTime:'Select Time',
    fromDate:'Start Date',
    fromTime:'Start Time',
    toDate:'End Date',
    toTime:'End Time',
    book:'Book',
    chooseTime:'Please choose date and time',
    bookOk:'Meeting booked',
    error:'Error occurred',
    scheduleGuide:`<div class="callout"><h3 class="font-bold mb-1">Booking & Availability Guidelines</h3><ul class="list-disc pl-4 space-y-1"><li><strong>Production Team</strong> ‚Äì Reserve reviews <strong>12:00 PM ‚Äì 2:00 PM</strong> (post-production). These slots have priority for the conference room.</li><li><strong>Delivery Drivers</strong> ‚Äì Aim for <strong>Wednesdays</strong> (non-Route day).</li><li><strong>CSRs</strong> ‚Äì Book any other open time that works for you and your manager.</li><li><strong>One Room. One Slot. One Team.</strong> ‚Äì Only <strong>one 30-minute</strong> booking at a time; no double-booking allowed.</li></ul></div>`,
    compAdjustTitle:'Compensation Adjustment',
    saveSlotBtn:'Save',
    addSlotTitle:'Set Availability',
    addSlotBtn:'Add Slot',
    slotListTitle:'Slots',
    slotsSaved:'slot(s) saved',
    availableShort:'Available',
    bookedShort:'Booked',
    errorPast:'Cannot add slots in the past.',
    errorOverlap:'Slot overlaps with existing.',
    errorMissing:'Please fill all fields.',
    errorInvalid:'Invalid time range.',
    intro:`<section id="review-intro">
      <h1>Your Opportunity to Shine</h1>
      <div class="intro-cards">
        <div class="info-card">
          <h2>Purpose</h2>
          <p>Highlight achievements, live our core values, and explain why you deserve a pay increase while receiving growth feedback.</p>
        </div>
        <div class="info-card">
          <h2>Core Values</h2>
          <ul class="values-list">
            <li>Accountable</li>
            <li>Attention to Details</li>
            <li>Team Player</li>
            <li>Tactical Risk Taker</li>
            <li>Better than Yesterday</li>
            <li>Value Reputation</li>
          </ul>
        </div>
        <div class="info-card">
          <h2>Rating System &amp; Process</h2>
          <p><strong>Rating System:</strong> For each question, please select a rating using the scale below:</p>
          <div class="rating-badges">
            <span class="badge badge-gray">1 = Below Expectations</span>
            <span class="badge badge-green">2 = Meets Expectations</span>
            <span class="badge badge-gold">3 = Exceeds Expectations</span>
          </div>
          <p>Important: Attendance and punctuality (Question&nbsp;1) carry significant weight in determining your overall score.</p>
          <h3 class="mt-2 font-semibold">Review Process</h3>
          <p><strong>When:</strong> Reviews will be held throughout July.</p>
          <p><strong>How to Schedule:</strong></p>
          <div class="process">
            <span>Complete this form &amp;</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>Submit to your Department Manager</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>Schedule an appointment w/ your Manager through this site.</span>
          </div>
          <p><strong>Timing:</strong> Each review lasts approximately 20 minutes, starting every half hour.</p>
          <p>Submit your form at least one week before your scheduled appointment.</p>
          <p><strong>Important Note:</strong> Please schedule your review outside of your regular working hours. If you attend on your day off or outside your scheduled shift, you will be compensated‚Äîjust make sure to message HR or your manager with the times so it can be added to payroll.</p>
          <h3 class="mt-2 font-semibold">Review Questions</h3>
          <p>Please answer clearly and concisely. Select your rating for each question.</p>
        </div>
      </div>
      <div class="callout">Raises take effect on the first pay period in August.</div>
    </section>`
  },
  es:{
    home:'Inicio',reviews:'Rese√±as',schedule:'Agenda',navTitle:'Revisiones Anuales de Empleados',navSubtitle:'Impulsa tu proceso de evaluaci√≥n',
    welcomeTitle:'Bienvenido al Portal de Evaluaciones',
    welcomeMsg:'Seleccione una opci√≥n en la barra de navegaci√≥n para ver sus evaluaciones o programar una reuni√≥n. Use el bot√≥n de idioma para cambiar entre ingl√©s y espa√±ol.',
    homeReviewsCardTitle:'Completa tu autoevaluaci√≥n',
    homeReviewsCardBody:'Prep√°rate respondiendo cada pregunta con ejemplos claros y lleva un registro de tu progreso en un solo lugar.',
    homeScheduleCardTitle:'Reserva tu horario de revisi√≥n',
    homeScheduleCardBody:'Explora los horarios disponibles, verifica los ya reservados y asegura un momento que funcione para ti y tu gerente.',
    homeGuideCardTitle:'¬øNecesitas ayuda?',
    homeGuideButton:'Abrir portal',
    comingSoon:'Pr√≥ximamente...',userId:'ID de usuario',password:'Contrase√±a',login:'Iniciar sesi√≥n',logout:'Cerrar sesi√≥n',
    loginFail:'Error al iniciar sesi√≥n',invalidPwd:'Contrase√±a inv√°lida.',
    noAccount:'Cuenta no encontrada. Por favor contacte a Sea Khun para ser agregado.',
    curWage:'Salario actual',newWage:'Nuevo salario',pctIncrease:'% Aumento:',
    finalExpTitle:'Expectativa de desempe√±o final',belowExp:'Debajo de las expectativas',meetsExp:'Cumple con las expectativas',exceedsExp:'Supera las expectativas',
    below:'Debajo',meets:'Cumple',exceeds:'Supera',
    notesPlaceholder:'Notas',contactQuestions:'Comun√≠quese con Sea Khun, gerente de HR/IT, si tiene alguna pregunta o inquietud.',empSignature:'Firma del empleado',mgrSignature:'Firma del gerente',signDate:'Fecha',submitReview:'Enviar revisi√≥n',
    employeeComments:'Comentarios del empleado',managerComments:'Comentarios del gerente',
    reviewSaved:'Revisi√≥n guardada',saveFailed:'No se pudo guardar la revisi√≥n',saving:'Guardando...',
    scheduleBtn:'Agendar Reuni√≥n de Revisi√≥n',
    bookPrompt:'¬øReservar esta hora?',
    cancel:'Cancelar',
    conflict:'Horario no disponible',
    selDate:'Seleccionar fecha',
    selTime:'Seleccionar hora',
    fromDate:'Fecha inicial',
    fromTime:'Hora inicial',
    toDate:'Fecha final',
    toTime:'Hora final',
    book:'Agendar',
    chooseTime:'Seleccione fecha y hora',
    bookOk:'Reuni√≥n programada',
    error:'Ocurri√≥ un error',
    scheduleGuide:`<div class="callout"><h3 class="font-bold mb-1">Pautas de reserva y disponibilidad</h3><ul class="list-disc pl-4 space-y-1"><li><strong>Equipo de Producci√≥n</strong> ‚Äì Reserve revisiones <strong>12:00 PM ‚Äì 2:00 PM</strong> (despu√©s de producci√≥n). Estas horas tienen prioridad para la sala de conferencias.</li><li><strong>Conductores de Entrega</strong> ‚Äì Trate de reservar <strong>los mi√©rcoles</strong> (d√≠a sin ruta).</li><li><strong>CSRs</strong> ‚Äì Programe cualquier otro horario disponible que funcione para usted y su gerente.</li><li><strong>Una sala. Un turno. Un equipo.</strong> ‚Äì Solo una reserva de <strong>30 minutos</strong>; no se permiten dobles reservas.</li></ul></div>`,
    compAdjustTitle:'Ajuste de compensaci√≥n',
    saveSlotBtn:'Guardar',
    addSlotTitle:'Establecer disponibilidad',
    addSlotBtn:'Agregar horario',
    slotListTitle:'Horarios',
    slotsSaved:'horario(s) guardado(s)',
    availableShort:'Disponible',
    bookedShort:'Reservado',
    errorPast:'No se pueden agregar horarios en el pasado.',
    errorOverlap:'El horario se superpone con uno existente.',
    errorMissing:'Complete todos los campos.',
    errorInvalid:'Rango de tiempo inv√°lido.',
    intro:`<section id="review-intro">
      <h1>Tu oportunidad para destacar</h1>
      <div class="intro-cards">
        <div class="info-card">
          <h2>Prop√≥sito</h2>
          <p>Destacar logros, vivir nuestros valores fundamentales y explicar por qu√© mereces un aumento mientras recibes comentarios para crecer.</p>
        </div>
        <div class="info-card">
          <h2>Valores fundamentales</h2>
          <ul class="values-list">
            <li>Responsabilidad</li>
            <li>Atenci√≥n al detalle</li>
            <li>Trabajo en equipo</li>
            <li>Tomador de riesgos t√°ctico</li>
            <li>Mejor que ayer</li>
            <li>Valorar la reputaci√≥n</li>
          </ul>
        </div>
        <div class="info-card">
          <h2>Sistema de calificaci√≥n y Proceso</h2>
          <p><strong>Sistema de calificaci√≥n:</strong> Para cada pregunta, seleccione una calificaci√≥n usando la escala a continuaci√≥n:</p>
          <div class="rating-badges">
            <span class="badge badge-gray">1 = Por debajo de las expectativas</span>
            <span class="badge badge-green">2 = Cumple con las expectativas</span>
            <span class="badge badge-gold">3 = Supera las expectativas</span>
          </div>
          <p>Importante: La asistencia y la puntualidad (Pregunta&nbsp;1) tienen un peso significativo en su puntaje general.</p>
          <h3 class="mt-2 font-semibold">Proceso de revisi√≥n</h3>
          <p><strong>Cu√°ndo:</strong> Las revisiones se realizar√°n durante todo julio.</p>
          <p><strong>C√≥mo programar:</strong></p>
          <div class="process">
            <span>Complete este formulario</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>Entregue el formulario completo a su gerente de departamento (en persona o por correo electr√≥nico)</span>
            <svg viewBox="0 0 16 16"><path d="M5 3l5 5-5 5" fill="none" stroke="currentColor" stroke-width="2"/></svg>
            <span>Agende una cita con Sea Khun</span>
          </div>
          <p><strong>Tiempo:</strong> Cada revisi√≥n dura aproximadamente 20 minutos y comienza cada media hora.</p>
          <p>Env√≠e su formulario al menos una semana antes de su cita programada.</p>
          <p><strong>Nota importante:</strong> Programe su revisi√≥n fuera de su horario de trabajo habitual. Si asiste en su d√≠a libre o fuera de su turno programado, se le compensar√°; solo aseg√∫rese de enviar un mensaje a Recursos Humanos o a su gerente con las horas para que puedan agregarse a la n√≥mina.</p>
          <h3 class="mt-2 font-semibold">Preguntas de revisi√≥n</h3>
          <p>Responda de forma clara y concisa. Seleccione su calificaci√≥n para cada pregunta.</p>
        </div>
      </div>
      <div class="callout">Los aumentos entran en vigor en el primer periodo de pago de agosto.</div>
    </section>`
  }
};
function t(key){
  if(config[key]&&config[key][lang])return config[key][lang];
  if(translations[lang]&&translations[lang][key])return translations[lang][key];
  return key;
}
function startLoading(){
  document.body.style.background='#fff';
  const lb=document.getElementById('loadingBar');
  if(lb)lb.classList.remove('hidden');
  loadingReviews=true;
}
function stopLoading(){
  document.body.style.background='';
  const lb=document.getElementById('loadingBar');
  if(lb)lb.classList.add('hidden');
  loadingReviews=false;
}
function setMenuState(open){
  const items=document.getElementById('navItems');
  const toggle=document.getElementById('navToggle');
  if(items){
    items.classList.toggle('show',!!open);
  }
  if(toggle){
    toggle.setAttribute('aria-expanded',open?'true':'false');
  }
}
function closeMenu(){setMenuState(false);}
function show(id){
  const sections=document.querySelectorAll('section[data-view]');
  if((id==='reviews' || id==='schedule') && !user){
    pendingSection=id;
    sections.forEach(s=>s.classList.add('hidden'));
    document.getElementById('login').classList.remove('hidden');
    return;
  }
  document.getElementById('login').classList.add('hidden');
  closeMenu();
  sections.forEach(s=>s.classList.add('hidden'));
  if(id==='reviews'){
    startLoading();
    if(user){
      loadReviews();
      loadSavedReview();
    }
    loadQuestions();
  }else if(id==='schedule'){
    initCalendar();
    document.getElementById(id).classList.remove('hidden');
  }else{
    if(id==='home'){
      const list=document.getElementById('reviewsList');
      if(list)list.innerHTML='';
    }
    document.getElementById(id).classList.remove('hidden');
  }
}

function openSchedule(){
  closeMenu();
  show('schedule');
  loadAvailability();
}
function applyTranslations(){
  document.querySelectorAll('[data-i18n-key]').forEach(el=>{
    const key=el.dataset.i18nKey;
    if(el.hasAttribute('data-i18n-placeholder'))el.placeholder=t(key);
    else if(el.hasAttribute('data-i18n-html'))el.innerHTML=t(key);
    else if(el.hasAttribute('data-i18n-alt'))el.alt=t(key);
    else el.textContent=t(key);
  });
  const toggle=document.getElementById('langToggle');
  if(toggle)toggle.checked=lang==='es';
  const loginBtn=document.getElementById('navLoginBtn');
  if(loginBtn)loginBtn.textContent=user?t('logout'):t('login');
}
function toggleMenu(){
  const items=document.getElementById('navItems');
  if(!items)return;
  const isOpen=!items.classList.contains('show');
  setMenuState(isOpen);
}
window.addEventListener('resize',()=>{
  if(window.innerWidth>=768){
    setMenuState(false);
  }
});
document.addEventListener('click',e=>{
  const items=document.getElementById('navItems');
  if(!items || !items.classList.contains('show')) return;
  const toggle=document.getElementById('navToggle');
  if((toggle && toggle.contains(e.target)) || items.contains(e.target)) return;
  setMenuState(false);
});
function init(){
  show('home');
  applyTranslations();
  document.getElementById('empSign').addEventListener('input',()=>updateSignDate('empSign','empSignDate'));
  document.getElementById('mgrSign').addEventListener('input',()=>updateSignDate('mgrSign','mgrSignDate'));
  loadQuestions();
  initCalendar();
  if(typeof google!=='undefined' && google.script && google.script.run){
    google.script.run.withSuccessHandler(c=>{
      config=c;
      applyTranslations();
      showDevButton();
    }).loadConfig();
  }else{
    showDevButton();
  }
}
function login(){
  const e=document.getElementById('userId').value;
  const p=document.getElementById('password').value;
  document.body.style.cursor='wait';
  startLoading();
  google.script.run
    .withSuccessHandler(r=>{
      document.body.style.cursor='';
      stopLoading();
      if(r.success){
        user=r.user;
        lang=user.lang;
        localStorage.setItem('lang',lang);
        document.getElementById('login').classList.add('hidden');
        document.getElementById('navLoginBtn').textContent=t('logout');
        applyTranslations();
        showDevButton();
        loadReviews();
        if(user.role==='DEV'){
          openDevPanel();
        }else{
          const target=pendingSection||'reviews';
          pendingSection=null;
          show(target);
        }
      }else{
        let msg='';
        if(r.error==='invalid_password')msg=t('invalidPwd');
        else if(r.error==='user_not_found')msg=t('noAccount');
        else msg=t('loginFail');
        alert(msg);
    }
    })
    .withFailureHandler(err=>{
      document.body.style.cursor='';
      stopLoading();
      alert(err.message||t('loginFail'));
    })
    .login(e,p);
}

function navLogin(){
  closeMenu();
  const loginDiv=document.getElementById('login');
  if(user){
    if(typeof google!==
      'undefined' && google.script && google.script.run){
      google.script.run.logout();
    }
    user=null;
    reviews=[];
    loginDiv.classList.add('hidden');
    document.getElementById('navLoginBtn').textContent=t('login');
    show('home');
  }else{
    loginDiv.classList.toggle('hidden');
    // hide dev panel when showing login
    const dev=document.getElementById('devPanel');
    if(dev)dev.classList.add('hidden');
  }
}

function toggleLang(){
  lang=document.getElementById('langToggle').checked?'es':'en';
  if(user) user.lang=lang;
  if(typeof google!=='undefined' && google.script && google.script.run){
    google.script.run.saveLang(lang);
  }
  localStorage.setItem('lang',lang);
  applyTranslations();
  renderReviews();
  renderQuestionList();
  if(user){
    loadSlots();
    loadAvailability();
  }
}
let reviews=[];
function loadReviews(){
  google.script.run.withSuccessHandler(r=>{
    reviews=r;
    renderReviews();
    fillSavedAnswers();
  }).listReviews();
}

function loadSavedReview(){
  if(!user || typeof google==='undefined' || !google.script || !google.script.run) return;
  google.script.run.withSuccessHandler(r=>{
    if(r){
      // replace existing saved review for selected year
      reviews=reviews.filter(rv=>!(rv.type==='SELF' && rv.employeeId==user.id && rv.data && Number(rv.data.year)==Number(selectedYear)));
      reviews.push(r);
    }
    fillSavedAnswers();
  }).getReviewByYear(selectedYear);
}
function renderReviews(){const c=document.getElementById('reviewsList');if(!c)return;c.innerHTML='';reviews.forEach(rv=>{const div=document.createElement('div');div.className='card';div.innerHTML='<b>'+rv.type+'</b> '+rv.status+'<br>'+JSON.stringify(rv.data);c.appendChild(div);});}

function showDevButton(){
  const btn=document.getElementById('devBtn');
  if(!btn)return;
  btn.classList.remove('hidden');
  btn.disabled=false;
}

function devOAuthLogin(){
  if(typeof google==='undefined' || !google.script || !google.script.run){
    return;
  }
  startLoading();
  google.script.run
    .withSuccessHandler(r=>{
      stopLoading();
      if(r && r.authorized){
        user={userId:r.email,name:r.email,role:'DEV',lang:'en',id:r.email};
        document.getElementById('navLoginBtn').textContent=t('logout');
        openDevPanel();
      }else{
        document.getElementById('accessDenied').classList.remove('hidden');
      }
    })
    .withFailureHandler(err=>{
      stopLoading();
      alert(err.message||'Auth failed');
    })
    .authorizeDev();
}

function devLink(){
  if(user && user.role==='DEV'){
    openDevPanel();
  }else{
    devOAuthLogin();
  }
}

function openDevPanel(){
  if(!user || user.role!=='DEV'){
    document.getElementById('accessDenied').classList.remove('hidden');
    return;
  }
  document.querySelectorAll('body>section').forEach(s=>s.classList.add('hidden'));
  const loginDiv=document.getElementById('login');
  if(loginDiv)loginDiv.classList.add('hidden');
  const nu=document.getElementById('newUserModal');
  if(nu)nu.classList.add('hidden');
  const rp=document.getElementById('resetPwModal');
  if(rp)rp.classList.add('hidden');
  loadUsers();
  document.getElementById('devPanel').classList.remove('hidden');
}

let questions=[];
function loadQuestions(){
  if(typeof google==='undefined'||!google.script||!google.script.run){
    questions=defaultQuestions;
    renderQuestionList();
    return;
  }
  google.script.run
    .withSuccessHandler(q=>{
      questions=(q&&q.length)?q:defaultQuestions;
      renderQuestionList();
    })
    .withFailureHandler(err=>{
      console.error('loadQuestions failed',err);
      questions=defaultQuestions;
      renderQuestionList();
    })
    .getQuestions();
}
function renderQuestionList(){
  const qd=document.getElementById('questionList');
  if(!qd)return;
  qd.innerHTML='';
  questions.forEach(q=>{
    const div=document.createElement('div');
    div.className='card q';
    div.dataset.id=q.id;
    let html='<label class="question-title">'+q[lang]+'</label>';
    if(q.rating!==false){
      html+='<div class="rating-group">'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="1"> 1 - '+t('below')+'</label>'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="2"> 2 - '+t('meets')+'</label>'
        +'<label><input type="radio" class="rating" name="rating-'+q.id+'" value="3"> 3 - '+t('exceeds')+'</label>'
        +'</div>';
    }else{
      html+='<input type="hidden" class="rating" value="">';
    }
    if(Array.isArray(q.extras)){
      q.extras.forEach(ex=>{
        let lbl=ex['label_'+lang]||ex.label;
        if(ex.type==='textarea' && ex.id!=='managerComments') lbl=t('employeeComments');
        html+='<label>'+lbl;
        if(ex.type==='textarea')html+='<textarea class="extra" data-sub="'+ex.id+'"></textarea>';
        else if(ex.type==='select'){
          html+='<select class="extra" data-sub="'+ex.id+'">';
          ex.options.forEach(o=>{html+='<option value="'+o+'">'+o+'</option>';});
          html+='</select>';
        }else {
          let attrs='';
          if(ex.type==='number' && (ex.id==='absences' || ex.id==='late')){
            attrs=' min="0" step="1"';
          }
          html+='<input type="'+ex.type+'" class="extra" data-sub="'+ex.id+'"'+attrs+'>';
        }
        html+='</label>';
      });
    }else if(q.extra==='textarea'){
      html+='<label>'+t('employeeComments')+'<textarea class="extra" data-sub="employeeComments"></textarea></label>';
    }else if(q.extra==='number'){
      html+='<input type="number" class="extra">';
    }
    html+='<label>'+t('managerComments')+'<textarea class="extra" data-sub="managerComments"></textarea></label>';
    div.innerHTML=html;
    qd.appendChild(div);
  });
  fillSavedAnswers();
  if(user&&user.role&&(['MANAGER','HR','DEV'].indexOf(user.role)!==-1)){
    document.getElementById('compAdjust').classList.remove('hidden');
  }
  if(loadingReviews){
    document.getElementById('reviews').classList.remove('hidden');
    stopLoading();
  }
  setupAutosave();
}

function fillSavedAnswers(){
  document.querySelectorAll('#questionList input.rating').forEach(r=>{r.checked=false;});
  document.querySelectorAll('#questionList .extra').forEach(e=>{e.value='';});
  document.querySelectorAll('#finalBlock input[name=finalExp]').forEach(r=>{r.checked=false;});
  document.getElementById('finalNotes').value='';
  document.getElementById('empSign').value='';
  document.getElementById('empSignDate').value='';
  document.getElementById('empSignDate').dataset.iso='';
  document.getElementById('mgrSign').value='';
  document.getElementById('mgrSignDate').value='';
  document.getElementById('mgrSignDate').dataset.iso='';
  currentReviewId=null;
  if(!user||!reviews||!reviews.length) return;
  const matches=reviews.filter(r=>
    r.type==='SELF' &&
    r.employeeId==user.id &&
    r.data && Number(r.data.year)==Number(selectedYear)
  );
  if(!matches.length) return;
  const rev=matches.sort((a,b)=>new Date(b.ts)-new Date(a.ts))[0];
  if(!rev.data || !rev.data.answers) return;
  currentReviewId=rev.id;
  const ans=rev.data.answers;
  Object.keys(ans).forEach(qid=>{
    const qDiv=document.querySelector('#questionList .q[data-id="'+qid+'"]');
    if(!qDiv) return;
    const val=ans[qid];
    if(val.score){
      const radio=qDiv.querySelector('input.rating[value="'+val.score+'"]');
      if(radio) radio.checked=true;
    }
    if(val.extra!==undefined){
      if(typeof val.extra==='object'){
        Object.keys(val.extra).forEach(k=>{
          const el=qDiv.querySelector('.extra[data-sub="'+k+'"]');
          if(el) el.value=val.extra[k];
        });
      }else{
        const el=qDiv.querySelector('.extra');
        if(el) el.value=val.extra;
      }
    }
  });
  if(rev.data.finalExpectation){
    const fe=rev.data.finalExpectation;
    if(fe.result){
      const r=document.querySelector('#finalBlock input[name=finalExp][value="'+fe.result+'"]');
      if(r) r.checked=true;
    }
    if(fe.notes) document.getElementById('finalNotes').value=fe.notes;
    if(fe.empSign){
      document.getElementById('empSign').value=fe.empSign.name||'';
      if(fe.empSign.ts){
        const d=new Date(fe.empSign.ts);
        document.getElementById('empSignDate').value=d.toLocaleString();
        document.getElementById('empSignDate').dataset.iso=fe.empSign.ts;
      }
    }
    if(fe.mgrSign){
      document.getElementById('mgrSign').value=fe.mgrSign.name||'';
      if(fe.mgrSign.ts){
        const d=new Date(fe.mgrSign.ts);
        document.getElementById('mgrSignDate').value=d.toLocaleString();
        document.getElementById('mgrSignDate').dataset.iso=fe.mgrSign.ts;
      }
    }
  }
}
function calcPct(){const c=parseFloat(document.getElementById('curWage').value||0);const n=parseFloat(document.getElementById('newWage').value||0);const pct=document.getElementById('pctInc');pct.textContent=c?(((n-c)/c)*100).toFixed(2):'0';}
function gatherAnswers(){
  const ans={};
  document.querySelectorAll('#questionList .q').forEach(d=>{
    const id=d.dataset.id;
    const ratingEl=d.querySelector('input.rating:checked, select.rating');
    const rating=ratingEl?ratingEl.value:'';
    const extraEls=d.querySelectorAll('.extra');
    let extra='';
    if(extraEls.length===1 && !extraEls[0].dataset.sub){
      extra=extraEls[0].value||'';
    }else if(extraEls.length>0){
      extra={};
      extraEls.forEach(e=>{extra[e.dataset.sub||'value']=e.value;});
    }
    ans[id]={score:rating,extra:extra};
  });
  return ans;
}
function gatherReviewData(){
  const answers=gatherAnswers();
  let comp=null;
  const adjBlock=document.getElementById('compAdjust');
  if(adjBlock&&!adjBlock.classList.contains('hidden')){
    comp={employeeId:user.id,current:document.getElementById('curWage').value,new:document.getElementById('newWage').value,pct:document.getElementById('pctInc').textContent};
  }
  const empDate=document.getElementById('empSignDate').dataset.iso;
  const mgrDate=document.getElementById('mgrSignDate').dataset.iso;
  const finalExp={
    result:document.querySelector('input[name=finalExp]:checked')?.value||'',
    notes:document.getElementById('finalNotes').value,
    empSign:{name:document.getElementById('empSign').value},
    mgrSign:{name:document.getElementById('mgrSign').value}
  };
  if(empDate) finalExp.empSign.ts=empDate;
  if(mgrDate) finalExp.mgrSign.ts=mgrDate;
  return {answers,comp,finalExp};
}

function updateSignDate(signId,dateId){
  const input=document.getElementById(signId);
  const dateField=document.getElementById(dateId);
  if(!input||!dateField) return;
  if(input.value.trim()){
    const now=new Date();
    dateField.value=now.toLocaleString();
    dateField.dataset.iso=now.toISOString();
  }else{
    dateField.value='';
    dateField.dataset.iso='';
  }
}

let autosaveTimeout;
let submitMsgTimeout;
function scheduleAutosave(){
  clearTimeout(autosaveTimeout);
  autosaveTimeout=setTimeout(autosaveReview,1000);
}
function autosaveReview(){
  if(!user) return;
  const data=gatherReviewData();
  const review={id:currentReviewId,employeeId:user.id,type:'SELF',status:'DRAFT',data:{year:selectedYear,answers:data.answers,finalExpectation:data.finalExp}};
  google.script.run.withFailureHandler(e=>console.error('autosave failed',e)).saveFullReview(review,data.comp);
}
function setupAutosave(){
  const form=document.getElementById('reviewForm');
  if(!form)return;
  const fields=form.querySelectorAll('input,textarea,select');
  fields.forEach(f=>{
    f.removeEventListener('input',scheduleAutosave);
    f.removeEventListener('change',scheduleAutosave);
    f.addEventListener('input',scheduleAutosave);
    f.addEventListener('change',scheduleAutosave);
  });
  window.addEventListener('beforeunload',autosaveReview);
}
function submitReview(){
  const data=gatherReviewData();
  const review={id:currentReviewId,employeeId:user.id,type:'SELF',status:'SUBMITTED',data:{year:selectedYear,answers:data.answers,finalExpectation:data.finalExp}};
  const msgEl=document.getElementById('submitMsg');
  msgEl.textContent='Saved';
  clearTimeout(submitMsgTimeout);
  submitMsgTimeout=setTimeout(()=>{msgEl.textContent='';},5000);
  google.script.run.withSuccessHandler(r=>{
    currentReviewId=r.id;
    loadReviews();
  }).saveFullReview(review,data.comp);
}

function loadUsers(){
  google.script.run.withSuccessHandler(renderUserTable).getAllUsers();
}

function renderUserTable(list){
  const body=document.querySelector('#userTable tbody');
  if(!body)return;
  body.innerHTML='';
  list.forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><span class="uid">${u.userId}</span><input class="uidEdit hidden border px-1" type="text" value="${u.userId}"></td>`+
      `<td><select class="roleSel" disabled><option>Employee</option><option>Manager</option><option>HR</option><option>DEV</option></select></td>`+
      `<td class="actions"><button type="button" class="editBtn" title="Edit">‚úèÔ∏è</button>`+
      `<button type="button" class="saveBtn hidden" title="Save">üíæ</button>`+
      `<button type="button" class="cancelBtn hidden" title="Cancel">‚úñ</button>`+
      `<button type="button" class="pwBtn" title="Change Password">üîë</button></td>`;
    tr.querySelector('.roleSel').value=u.role;
    tr.querySelector('.uid').onclick=()=>enableEdit(tr,u.userId);
    tr.querySelector('.editBtn').onclick=()=>enableEdit(tr,u.userId);
    tr.querySelector('.cancelBtn').onclick=()=>disableEdit(tr);
    tr.querySelector('.saveBtn').onclick=()=>saveRow(tr,u.userId);
    tr.querySelector('.pwBtn').onclick=()=>showResetPwModal(u.userId);
    body.appendChild(tr);
  });
}

function enableEdit(tr,id){
  tr.querySelector('.uid').classList.add('hidden');
  tr.querySelector('.uidEdit').classList.remove('hidden');
  tr.querySelector('.roleSel').disabled=false;
  tr.querySelector('.editBtn').classList.add('hidden');
  tr.querySelector('.saveBtn').classList.remove('hidden');
  tr.querySelector('.cancelBtn').classList.remove('hidden');
}

function disableEdit(tr){
  tr.querySelector('.uid').classList.remove('hidden');
  tr.querySelector('.uidEdit').classList.add('hidden');
  tr.querySelector('.roleSel').disabled=true;
  tr.querySelector('.editBtn').classList.remove('hidden');
  tr.querySelector('.saveBtn').classList.add('hidden');
  tr.querySelector('.cancelBtn').classList.add('hidden');
}

function saveRow(tr,oldId){
  const newId=tr.querySelector('.uidEdit').value.trim();
  const role=tr.querySelector('.roleSel').value;
  const after=()=>{disableEdit(tr);loadUsers();};
  if(newId!==oldId){
    google.script.run.withSuccessHandler(()=>{
      google.script.run.withSuccessHandler(after).updateUserRole(newId,role);
    }).withFailureHandler(err=>alert(err.message)).updateUserID(oldId,newId);
  }else{
    google.script.run.withSuccessHandler(after).withFailureHandler(err=>alert(err.message)).updateUserRole(oldId,role);
  }
}


function showNewUserModal(){
  document.getElementById('newUid').value='';
  document.getElementById('newRole').value='Employee';
  document.getElementById('newPw1').value='';
  document.getElementById('newPw2').value='';
  document.getElementById('newUserModal').classList.remove('hidden');
}

function addNewUser(){
  const uid=document.getElementById('newUid').value.trim();
  const r=document.getElementById('newRole').value;
  const p1=document.getElementById('newPw1').value;
  const p2=document.getElementById('newPw2').value;
  if(p1!==p2){alert('Passwords do not match');return;}
  google.script.run.withSuccessHandler(()=>{document.getElementById('newUserModal').classList.add('hidden');loadUsers();}).withFailureHandler(err=>alert(err.message)).addNewUser({userId:uid,password:p1,role:r});
}

function showResetPwModal(uid){
  resetUid=uid;
  document.getElementById('resetPw1').value='';
  document.getElementById('resetPw2').value='';
  document.getElementById('resetPwModal').classList.remove('hidden');
}

function resetPassword(){
  const p1=document.getElementById('resetPw1').value;
  const p2=document.getElementById('resetPw2').value;
  if(p1!==p2){alert('Passwords do not match');return;}
  google.script.run.withSuccessHandler(()=>{document.getElementById('resetPwModal').classList.add('hidden');loadUsers();}).withFailureHandler(err=>alert(err.message)).updateUserPassword(resetUid,p1);
}

function confirmClearReviews(){
  if(!confirm('Delete all review data?')) return;
  google.script.run
    .withSuccessHandler(()=>alert('All reviews deleted'))
    .withFailureHandler(err=>alert(err.message))
    .deleteAllReviews();
}

// ---- Modern Calendar Scheduling -----
let calendar;
function initCalendar(){
  const el=document.getElementById('calendar');
  if(!el) return;
  if(!calendar){
    calendar=new FullCalendar.Calendar(el,{
      initialView:'dayGridMonth',
      locale:lang==='es'?'es':'en',
      headerToolbar:{start:'prev,next today',center:'title',end:''},
      height:'auto',
      datesSet:loadSlots
    });
  }
  calendar.setOption('locale',lang==='es'?'es':'en');
  calendar.render();
  loadSlots();
  const role=user?String(user.role||'').toUpperCase():'';
  document.getElementById('availForm').classList.toggle('hidden',!(role==='MANAGER'||role==='DEV'));
}
function loadSlots(){
  if(!user) return;
  google.script.run.withSuccessHandler(res=>{
    calendar.getEvents().forEach(e=>e.remove());
    const map={};
    res.forEach(s=>{
      if(s.userId!==user.userId) return;
      const d=s.start.slice(0,10);
      if(!map[d]) map[d]={total:0,booked:0};
      map[d].total++;
      if(s.employeeId) map[d].booked++;
    });
    Object.keys(map).forEach(d=>{
      const info=map[d];
      const remaining=info.total-info.booked;
      if(remaining>0){
        calendar.addEvent({start:d,allDay:true,title:remaining+' '+t('availableShort'),backgroundColor:'#34d399',borderColor:'#34d399',textColor:'#fff'});
      }else{
        calendar.addEvent({start:d,allDay:true,title:info.booked+' '+t('bookedShort'),backgroundColor:'#ef4444',borderColor:'#ef4444',textColor:'#fff'});
      }
    });
  }).getAvailability();
}
function slotClick(info){
  const b=info.event.extendedProps.bookedBy;
  if(b){alert(t('conflict'));return;}
  if(!confirm(t('bookPrompt'))) return;
  google.script.run.withSuccessHandler(r=>{if(r.status==='ok'){alert(t('bookOk'));loadSlots();loadAvailability();}else{alert(t('conflict'));loadSlots();}}).bookSlot({slotId:info.event.id,employeeId:user.userId});
}
function addAvailability(){
  const sd=document.getElementById('availFromDate').value;
  const st=document.getElementById('availFromTime').value;
  const ed=document.getElementById('availToDate').value;
  const et=document.getElementById('availToTime').value;
  if(!sd||!st||!ed||!et){showError(t('errorMissing'));return;}
  google.script.run.withSuccessHandler(res=>{
    loadAvailability();
    loadSlots();
    const n=(res.added||[]).length;
    if(n) showSnackbar(n+' '+t('slotsSaved'));
  }).withFailureHandler(err=>{
    showError(mapError(err));
  }).postAvailability({start:sd+'T'+st,end:ed+'T'+et});
}
function loadAvailability(){
  google.script.run.withSuccessHandler(renderSlotList).getAvailability();
}
function renderSlotList(slots){
  const list=document.getElementById('slotList');
  const card=document.getElementById('slotCard');
  if(!list||!card) return;
  list.innerHTML='';
  let count=0;
  slots.forEach(s=>{
    if(s.userId!==user.userId) return;
    count++;
    const row=document.createElement('div');
    row.className='slot-row';
    const span=document.createElement('span');
    span.className='slot-range';
    span.textContent=formatRange(s.start,s.end);
    row.appendChild(span);
    const inp=document.createElement('input');
    inp.type='text';
    inp.className='slot-assign';
    inp.value=s.employeeId||'';
    if(s.employeeId){
      inp.disabled=true;
      row.classList.add('slot-row-booked');
    }
    row.appendChild(inp);
    if(!s.employeeId){
      const btn=document.createElement('button');
      btn.type='button';
      btn.textContent=t('saveSlotBtn');
      btn.className='primary slot-save';
      btn.onclick=()=>saveSlot(s.id,inp.value,inp);
      row.appendChild(btn);
    }
    list.appendChild(row);
  });
  card.classList.toggle('hidden',count===0);
}
function saveSlot(id,val,inputEl){
  if(!val) return;
  google.script.run.withSuccessHandler(()=>{loadAvailability();loadSlots();}).withFailureHandler(err=>alert(err.message)).bookSlot({slotId:id,employeeId:val});
}
function formatRange(start,end){
  const opts={hour:'numeric',minute:'2-digit'};
  const a=new Date(start).toLocaleTimeString(lang==='es'?'es':'en',opts);
  const b=new Date(end).toLocaleTimeString(lang==='es'?'es':'en',opts);
  return a+' \u2013 '+b;
}
function showSnackbar(msg){
  let bar=document.getElementById('snackbar');
  if(!bar) return;
  bar.textContent=msg;
  bar.classList.add('show');
  setTimeout(()=>bar.classList.remove('show'),3000);
}
function showError(msg){
  console.error(msg);
  const modal=document.getElementById('errorModal');
  const txt=document.getElementById('errorText');
  if(txt)txt.textContent=msg;
  if(modal)modal.classList.remove('hidden');
}
function closeError(){
  const modal=document.getElementById('errorModal');
  if(modal)modal.classList.add('hidden');
}
function mapError(err){
  const m=err&&err.message||'';
  if(m==='past') return t('errorPast');
  if(m==='overlap') return t('errorOverlap');
  if(m==='missing') return t('errorMissing');
  if(m==='invalid') return t('errorInvalid');
  return t('error');
}
document.addEventListener('DOMContentLoaded',init);
</script>
</head>
<body>
<header class="app-header">
  <div class="nav-bar">
    <div class="nav-brand">
      <img src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png" alt="Logo">
      <div class="brand-text">
        <span class="brand-title" data-i18n-key="navTitle">Employee Annual Reviews</span>
        <span class="brand-sub" data-i18n-key="navSubtitle">Empower your review journey</span>
      </div>
    </div>
    <button type="button" id="navToggle" class="nav-toggle material-icons" aria-expanded="false" aria-controls="navItems" onclick="toggleMenu()">menu</button>
    <div id="navItems" class="nav-items">
      <button type="button" onclick="show('home')" data-i18n-key="home">Home</button>
      <button type="button" onclick="show('reviews')" data-i18n-key="reviews">Reviews</button>
      <button type="button" onclick="openSchedule()" data-i18n-key="schedule">Schedule</button>
      <div class="lang-switch">
        <span>EN</span>
        <label class="switch"><input type="checkbox" id="langToggle" onchange="toggleLang()"><span class="slider"></span></label>
        <span>ES</span>
      </div>
      <button type="button" id="navLoginBtn" onclick="navLogin()" data-i18n-key="login">Login</button>
      <button type="button" id="devBtn" onclick="devLink()">Dev</button>
    </div>
  </div>
</header>
<div id="loadingBar" class="loading-bar hidden"><span></span></div>
<div id="snackbar"></div>
<div id="errorModal" class="modal hidden">
  <div class="bg-white rounded-xl p-6 w-80 space-y-4">
    <p id="errorText" class="text-center"></p>
    <button type="button" class="primary w-full" onclick="closeError()">OK</button>
  </div>
</div>
<main>
  <section id="home" class="hidden" data-view>
    <div class="home-hero">
      <h1 data-i18n-key="welcomeTitle">Welcome to the Employee Review Portal</h1>
      <p data-i18n-key="welcomeMsg">Select an option from the navigation bar to view your reviews or schedule a meeting. Use the language button to switch between English and Spanish.</p>
    </div>
    <div class="home-actions">
      <article class="home-card">
        <h2 data-i18n-key="homeReviewsCardTitle">Complete your self-review</h2>
        <p data-i18n-key="homeReviewsCardBody">Stay prepared by answering each question with clear examples and track your progress in one place.</p>
        <button type="button" onclick="show('reviews')" data-i18n-key="reviews">Reviews</button>
      </article>
      <article class="home-card">
        <h2 data-i18n-key="homeScheduleCardTitle">Reserve your review time</h2>
        <p data-i18n-key="homeScheduleCardBody">Browse available slots, see what‚Äôs already booked, and lock in a time that works for you and your manager.</p>
        <button type="button" onclick="openSchedule()" data-i18n-key="schedule">Schedule</button>
      </article>
      <article class="home-card secondary">
        <h2 data-i18n-key="homeGuideCardTitle">Need a hand?</h2>
        <p data-i18n-key="contactQuestions">Please contact Sea Khun HR/IT Manager with any questions or concerns.</p>
        <button type="button" onclick="if(user){show('reviews');}else{navLogin();}" data-i18n-key="homeGuideButton">Open portal</button>
      </article>
    </div>
  </section>
  <section id="reviews" class="hidden" data-view>
    <form id="reviewForm" onsubmit="submitReview();return false;">
      <div data-i18n-key="intro" data-i18n-html></div>
      <div id="reviewsList"></div>
      <div id="questionList"></div>
      <div id="compAdjust" class="card hidden">
        <div class="card-title" data-i18n-key="compAdjustTitle">Compensation Adjustment</div>
        <label><span data-i18n-key="curWage">Current Wage</span><input type="number" id="curWage" oninput="calcPct()"></label>
        <label><span data-i18n-key="newWage">New Wage</span><input type="number" id="newWage" oninput="calcPct()"></label>
        <div><span data-i18n-key="pctIncrease">% Increase:</span> <span id="pctInc">0</span>%</div>
      </div>
      <div id="finalBlock" class="card">
        <p class="card-title" data-i18n-key="finalExpTitle">Final Performance Expectation</p>
        <label><input type="radio" name="finalExp" value="below"> <span data-i18n-key="belowExp">Below Expectations</span></label>
        <label><input type="radio" name="finalExp" value="meets"> <span data-i18n-key="meetsExp">Meets Expectations</span></label>
        <label><input type="radio" name="finalExp" value="exceeds"> <span data-i18n-key="exceedsExp">Exceeds Expectations</span></label>
        <label><span data-i18n-key="notesPlaceholder">Notes</span>
          <textarea id="finalNotes" data-i18n-key="notesPlaceholder" data-i18n-placeholder placeholder="Notes"></textarea>
        </label>
      </div>
      <div class="card">
        <label>
          <span data-i18n-key="empSignature">Employee Signature</span>
          <input type="text" id="empSign" class="signature">
        </label>
        <input type="text" id="empSignDate" class="sign-date" readonly data-i18n-key="signDate" data-i18n-placeholder placeholder="Date">
        <label>
          <span data-i18n-key="mgrSignature">Manager Signature</span>
          <input type="text" id="mgrSign" class="signature">
        </label>
        <input type="text" id="mgrSignDate" class="sign-date" readonly data-i18n-key="signDate" data-i18n-placeholder placeholder="Date">
      </div>
      <div class="form-actions">
        <button class="primary" type="submit" data-i18n-key="submitReview">Submit Review</button>
        <button id="btnSchedule" class="primary secondary" type="button" onclick="show('schedule')" data-i18n-key="scheduleBtn"></button>
        <span id="submitMsg"></span>
      </div>
      <div class="form-footnote"><small data-i18n-key="contactQuestions">Please contact Sea Khun HR/IT Manager with any questions or concerns.</small></div>
    </form>
  </section>
  <section id="schedule" class="hidden" data-view>
    <div data-i18n-key="scheduleGuide" data-i18n-html></div>
    <div id="scheduleFlex">
      <div class="schedule-form">
        <div id="availForm" class="card hidden">
          <div class="card-title" data-i18n-key="addSlotTitle">Set Availability</div>
          <label><span data-i18n-key="fromDate">Start Date</span>
            <input type="date" id="availFromDate">
          </label>
          <label><span data-i18n-key="fromTime">Start Time</span>
            <input type="time" id="availFromTime" step="1800">
          </label>
          <label><span data-i18n-key="toDate">End Date</span>
            <input type="date" id="availToDate">
          </label>
          <label><span data-i18n-key="toTime">End Time</span>
            <input type="time" id="availToTime" step="1800">
          </label>
          <button class="primary" type="button" onclick="addAvailability()" data-i18n-key="addSlotBtn">Add Slot</button>
          <div id="availMsg"></div>
        </div>
        <div id="slotCard" class="card hidden">
          <div class="card-title" data-i18n-key="slotListTitle">Slots</div>
          <div id="slotList"></div>
        </div>
      </div>
      <div id="calendarWrapper" class="card">
        <div id="calendar"></div>
      </div>
    </div>
  </section>
</main>
<section id="devPanel" class="hidden fixed inset-0 p-4 pt-16 overflow-auto bg-black/30 flex items-start justify-center">
  <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-3xl">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold">Developer Console</h3>
      <div class="flex items-center gap-4">
        <button type="button" class="text-red-600" onclick="confirmClearReviews()">Clear Reviews</button>
        <button onclick="document.getElementById('devPanel').classList.add('hidden')">‚úñ</button>
      </div>
    </div>
    <div class="overflow-x-auto">
      <table id="userTable">
        <thead><tr><th>UserID</th><th>Role</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <button type="button" id="addUserFab" class="fixed bottom-6 right-6 bg-emerald-600 text-white rounded-full w-12 h-12 shadow-lg text-xl" onclick="showNewUserModal()" title="Add New User">+</button>
  </div>
  <div id="newUserModal" class="modal hidden">
    <div class="bg-white rounded-xl p-6 w-80 space-y-4">
      <h4 class="text-lg font-semibold text-center">Add User</h4>
      <input id="newUid" class="w-full border px-2 py-1" placeholder="UserID">
      <select id="newRole" class="w-full border px-2 py-1">
        <option>Employee</option><option>Manager</option><option>HR</option><option>DEV</option>
      </select>
      <input id="newPw1" type="password" class="w-full border px-2 py-1" placeholder="Password">
      <input id="newPw2" type="password" class="w-full border px-2 py-1" placeholder="Confirm Password">
      <div class="flex justify-between">
        <button type="button" class="primary" onclick="addNewUser()">Save</button>
        <button type="button" onclick="document.getElementById('newUserModal').classList.add('hidden')">Cancel</button>
      </div>
    </div>
  </div>
  <div id="resetPwModal" class="modal hidden">
    <div class="bg-white rounded-xl p-6 w-80 space-y-4">
      <h4 class="text-lg font-semibold text-center">Reset Password</h4>
      <input id="resetPw1" type="password" class="w-full border px-2 py-1" placeholder="New Password">
      <input id="resetPw2" type="password" class="w-full border px-2 py-1" placeholder="Confirm Password">
      <div class="flex justify-between">
        <button type="button" class="primary" onclick="resetPassword()">Save</button>
        <button type="button" onclick="document.getElementById('resetPwModal').classList.add('hidden')">Cancel</button>
      </div>
    </div>
  </div>
</section>
<section id="accessDenied" class="hidden fixed inset-0 flex items-center justify-center bg-white/90">
  <div class="bg-white rounded-xl shadow-xl p-8 text-center space-y-4">
    <h3 class="text-xl font-semibold">Access Denied</h3>
    <p>You are not authorized to use this console.</p>
    <button type="button" class="primary" onclick="document.getElementById('accessDenied').classList.add('hidden')">Close</button>
  </div>
</section>
<form id="login" class="hidden" onsubmit="login();return false;">
  <div class="card-like">
    <img src="https://www.dublincleaners.com/wp-content/uploads/2024/12/Dublin-Logos-stacked.png" alt="Logo">
    <h1 data-i18n-key="navTitle">Employee Annual Reviews</h1>
    <label>
      <span data-i18n-key="userId">User ID</span>
      <input type="text" id="userId" data-i18n-key="userId" data-i18n-placeholder>
    </label>
    <label>
      <span data-i18n-key="password">Password</span>
      <input type="password" id="password" data-i18n-key="password" data-i18n-placeholder>
    </label>
    <button class="primary" type="submit" data-i18n-key="login">Login</button>
  </div>
</form>
</body>
</html>
